# 学生删除管理命令使用指南

## 命令概述

`delete_students` 是一个安全的Django管理命令，用于删除学生记录及其相关数据。命令包含完整的安全检查、预览功能和审计跟踪。

## 基本语法

```bash
python manage.py delete_students [OPTIONS]
```

## 参数选项

### 学生选择参数 (必选其一)

- `--id <student_id>`: 删除单个学生
- `--range <start-end>`: 删除ID范围内的学生
- `--ids <id1,id2,id3>`: 删除多个指定ID的学生

### 安全和行为参数 (可选)

- `--dry-run`: 预览模式，显示将要删除的内容但不实际删除
- `--force`: 强制删除，跳过确认提示
- `--include-inactive`: 包含非活跃学生 (默认只处理活跃学生)
- `--reason <reason>`: 删除原因，用于记录和审计

## 使用示例

### 1. 删除单个学生 (预览模式)

```bash
# 预览将要删除的学生ID为123的记录
python manage.py delete_students --id 123 --dry-run
```

### 2. 删除单个学生 (实际执行)

```bash
# 删除学生ID为123的记录，需要确认
python manage.py delete_students --id 123 --reason "学生退学"
```

### 3. 删除ID范围内的学生

```bash
# 预览删除ID从100到110的学生
python manage.py delete_students --range 100-110 --dry-run

# 实际删除（需要确认）
python manage.py delete_students --range 100-110 --reason "批量清理测试数据"
```

### 4. 删除多个指定ID的学生

```bash
# 删除ID为1,5,8,12的学生
python manage.py delete_students --ids 1,5,8,12 --reason "清理无效记录"
```

### 5. 强制删除（跳过确认）

```bash
# 强制删除，不需要输入确认
python manage.py delete_students --id 123 --force --reason "自动清理"
```

### 6. 包含非活跃学生

```bash
# 删除包括非活跃状态的学生
python manage.py delete_students --range 50-60 --include-inactive --reason "完整清理"
```

## 安全功能

### 1. 预览模式
使用 `--dry-run` 参数可以安全预览将要删除的内容：

```bash
python manage.py delete_students --range 1-10 --dry-run
```

**输出示例：**
```
预览模式 - 不会实际删除任何数据
============================================================
即将删除的学生:
============================================================
ID: 1 | John Smith (年龄: 25) | 状态: 活跃 | 等级: 初级
    邮箱: john@example.com
    电话: 0412 345 678
ID: 2 | Jane Doe (年龄: 30) | 状态: 活跃 | 等级: 中级
    邮箱: jane@example.com

相关数据统计:
  注册记录: 3 (活跃: 2)
  活动记录: 15 (最近30天: 5)
  考勤记录: 8 (最近30天: 3)

预览：将删除 2 名学生
```

### 2. 安全警告系统
命令会自动检查并警告以下情况：
- 存在活跃注册记录
- 最近30天内有活动记录
- 最近30天内有考勤记录
- 学生拥有大量历史活动（超过10个）

### 3. 确认机制
除非使用 `--force` 参数，命令会要求确认：

```
您即将删除 2 名学生及其相关的 26 条记录。
此操作无法撤销！

请输入 'DELETE' 来确认删除操作:
```

必须准确输入 `DELETE` 才能继续执行。

## 删除的数据范围

当删除一个学生时，以下相关数据也会被删除：
- 学生的所有注册记录 (Enrollments)
- 学生的所有活动记录 (StudentActivities)
- 学生的所有考勤记录 (Attendances)
- 学生的标签关联关系

## 审计跟踪

每次删除操作都会：
1. 创建一条活动记录说明删除原因
2. 记录删除的相关数据统计
3. 在删除完成后显示详细摘要

**删除摘要示例：**
```
============================================================
删除操作完成
============================================================
成功删除的学生: 2
删除的注册记录: 3
删除的活动记录: 16
删除的考勤记录: 8

删除操作已完成。
```

## 错误处理

- 如果某个学生删除失败，其他学生的删除会继续执行
- 所有错误都会在最终摘要中显示
- 使用数据库事务确保数据一致性

## 限制和保护

- ID范围最大不能超过1000个学生
- ID列表最大不能超过1000个
- 默认只处理活跃学生（除非使用 `--include-inactive`）
- 必须提供删除原因（用于审计）

## 常见使用场景

### 1. 清理测试数据
```bash
# 预览测试数据
python manage.py delete_students --range 1000-1100 --dry-run

# 清理测试数据
python manage.py delete_students --range 1000-1100 --reason "清理测试数据"
```

### 2. 删除重复或错误记录
```bash
# 删除特定的错误记录
python manage.py delete_students --ids 123,456,789 --reason "删除重复记录"
```

### 3. 学生退学处理
```bash
# 单个学生退学
python manage.py delete_students --id 123 --reason "学生主动退学"
```

## 最佳实践

1. **始终先使用预览模式**：在实际删除前使用 `--dry-run` 检查
2. **提供清晰的删除原因**：便于后续审计和追踪
3. **小批量操作**：大量删除时分批执行，便于监控和回滚
4. **备份重要数据**：在大批量删除前备份数据库
5. **检查相关数据**：注意警告信息，确认删除的影响范围

## 注意事项

⚠️ **重要警告**：
- 删除操作无法撤销
- 会同时删除所有相关的注册、活动和考勤记录
- 建议在生产环境使用前先在测试环境验证

📝 **审计建议**：
- 所有删除操作都应提供详细的原因说明
- 保留删除摘要的日志记录
- 定期检查删除操作的合理性