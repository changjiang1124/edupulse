{% extends 'base.html' %}
{% load static %}

{% block title %}{{ class.course.name }} - {{ class.date }} - Class Details - EduPulse{% endblock %}

{% block extra_css %}
<style>
.class-hero {
    background: white;
    color: #374151;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}
.class-meta-card {
    border: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    border-radius: 12px;
}
.class-meta-card .card-header {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    border-radius: 12px 12px 0 0 !important;
}
.student-list-item {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
    position: relative;
}
.student-list-item:hover {
    background-color: #f8fafc;
    transform: translateX(4px);
    z-index: 1;
}
.participation-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}
.participation-enrolled {
    background-color: #dbeafe;
    color: #1e40af;
}
.participation-pending {
    background-color: #fef3c7;
    color: #92400e;
}
.participation-temp {
    background-color: #fef3c7;
    color: #92400e;
}
.attendance-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}
.attendance-present {
    background-color: #10b981;
}
.attendance-absent {
    background-color: #ef4444;
}
.attendance-late {
    background-color: #f59e0b;
}
.attendance-pending {
    background-color: #6b7280;
}
.attendance-unmarked {
    background-color: #9ca3af;
}
.dropdown-menu {
    z-index: 1050 !important;
    position: absolute !important;
}

.z-index-active {
    z-index: 100 !important;
    position: relative;
    transform: none !important;
}
.z-index-card-active {
    z-index: 2000 !important;
    position: relative;
    transform: none !important;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Standard Detail Page Header -->
<div class="mb-3">
    <a href="{% url 'academics:class_list' %}" class="text-decoration-none text-muted">
        <i class="fas fa-arrow-left me-2"></i>Back to Classes
    </a>
</div>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h2 fw-bold mb-2">{{ class.course.name }}</h1>
        <div class="text-muted mb-3">{{ class.date|date:"l, d F Y" }} at {{ class.start_time|time:"g:i A" }}</div>
        <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-primary text-white px-3 py-2">
                <i class="fas fa-clock me-1"></i>{{ class.duration_minutes }} minutes
            </span>
            {% if class.teacher %}
            <span class="badge bg-info text-white px-3 py-2">
                <i class="fas fa-user-tie me-1"></i>{{ class.teacher.first_name }} {{ class.teacher.last_name }}
            </span>
            {% endif %}
            {% if class.classroom %}
            <span class="badge bg-warning text-dark px-3 py-2">
                <i class="fas fa-map-marker-alt me-1"></i>{{ class.classroom.name }}
            </span>
            {% endif %}
            <span class="badge {{ class.is_active|yesno:'bg-success,bg-secondary' }} text-white px-3 py-2">
                {{ class.is_active|yesno:'Active,Inactive' }}
            </span>
        </div>

    </div>
    <div class="d-flex flex-column gap-2">
        {% if user.role == 'admin' %}
        <a href="{% url 'academics:class_edit' class.pk %}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit Class
        </a>
        {% endif %}
        <a href="{% url 'academics:course_detail' class.course.pk %}" class="btn btn-outline-primary">
            <i class="fas fa-book me-2"></i>View Course
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        
        <!-- Class Information -->
        <div class="card class-meta-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-primary"></i>Class Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-primary me-3">
                                <i class="fas fa-book"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Course</small>
                                <strong>
                                    <a href="{% url 'academics:course_detail' class.course.pk %}" class="text-decoration-none">
                                        {{ class.course.name }}
                                    </a>
                                </strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-info me-3">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Date & Time</small>
                                <strong>{{ class.date|date:"d/m/Y" }} at {{ class.start_time|time:"g:i A" }}</strong>
                            </div>
                        </div>
                    </div>
                    
                    {% if class.teacher %}
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-primary me-3">
                                {{ class.teacher.first_name|first }}{{ class.teacher.last_name|first }}
                            </div>
                            <div>
                                <small class="text-muted d-block">Instructor</small>
                                <strong>{{ class.teacher.first_name }} {{ class.teacher.last_name }}</strong>
                                {% if class.teacher != class.course.teacher %}
                                <br><small class="text-warning">
                                    <i class="fas fa-info-circle me-1"></i>Different from course teacher
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if class.classroom %}
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-warning me-3">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Location</small>
                                <strong>{{ class.classroom.name }}</strong>
                                {% if class.facility %}<br><small class="text-muted">{{ class.facility.name }}</small>{% endif %}
                                {% if class.classroom != class.course.classroom %}
                                <br><small class="text-warning">
                                    <i class="fas fa-info-circle me-1"></i>Different from course classroom
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Students in This Class -->
        <div class="card class-meta-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2 text-primary"></i>
                    Students <span class="badge bg-primary ms-2">{{ class_students|length }}</span>
                </h5>
                {% if can_manage_makeup %}
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-warning" onclick="openMakeupModalFromTarget()">
                        <i class="fas fa-arrows-turn-to-dots me-1"></i>Schedule Makeup
                    </button>
                </div>
                {% endif %}
            </div>
            <div class="card-body">
                {% if class_students %}
                    {% for student_info in class_students %}
                    <div class="student-list-item border">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-3">
                                        {{ student_info.student.first_name|first }}{{ student_info.student.last_name|first }}
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ student_info.student.first_name }} {{ student_info.student.last_name }}</div>
                                        <small class="text-muted">{{ student_info.student.contact_email|default:"No email" }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <span class="participation-badge participation-{{ student_info.participation_type }}">
                                    {% if student_info.participation_type == 'enrolled' %}
                                        <i class="fas fa-user-check me-1"></i>{{ student_info.enrollment_status_display|default:"Enrolled" }}
                                    {% elif student_info.participation_type == 'pending' %}
                                        <i class="fas fa-hourglass-half me-1"></i>{{ student_info.enrollment_status_display|default:"Pending" }}
                                    {% elif student_info.participation_type == 'temp' %}
                                        <i class="fas fa-user-clock me-1"></i>Temporary
                                    {% else %}
                                        <i class="fas fa-user-plus me-1"></i>Added
                                    {% endif %}
                                </span>
                                {% if student_info.source_makeup and student_info.source_makeup.status == 'scheduled' %}
                                    <span class="badge bg-warning text-dark mt-1">Makeup Out</span>
                                {% endif %}
                                {% if student_info.target_makeup and student_info.target_makeup.status == 'scheduled' %}
                                    <span class="badge bg-info text-dark mt-1">Makeup In</span>
                                {% endif %}
                            </div>
                            <div class="col-md-2">
                                {% with student_info.attendance_status as status %}
                                <div class="attendance-status attendance-{{ status|default:'pending' }}"></div>
                                <small class="text-muted">
                                    {% if status == 'present' %}Present
                                    {% elif status == 'absent' %}Absent
                                    {% elif status == 'late' %}Late
                                    {% elif status == 'unmarked' %}Unmarked
                                    {% else %}Pending
                                    {% endif %}
                                </small>
                                {% endwith %}
                            </div>
                            <div class="col-md-1">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'students:student_detail' student_info.student.pk %}">View Student</a></li>
                                        {% if can_manage_makeup %}
                                        <li><a class="dropdown-item" href="#" onclick="openMakeupModalFromSource({{ student_info.student.pk }}, '{{ student_info.student.first_name|escapejs }} {{ student_info.student.last_name|escapejs }}'); return false;">Schedule Makeup</a></li>
                                        {% endif %}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-plus fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No students assigned</h6>
                        <p class="text-muted mb-3">Use makeup scheduling to bring students into this class.</p>
                        {% if can_manage_makeup %}
                        <button class="btn btn-outline-warning" onclick="openMakeupModalFromTarget()">
                            <i class="fas fa-arrows-turn-to-dots me-2"></i>Schedule Makeup
                        </button>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Attendance History -->
        <div class="card class-meta-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clipboard-check me-2 text-primary"></i>Attendance History</h5>
                <a href="{% url 'enrollment:attendance_mark' class.pk %}" class="btn btn-sm btn-success">
                    <i class="fas fa-check me-1"></i>Mark Attendance
                </a>
            </div>
            <div class="card-body">
                {% if attendances %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in attendances %}
                                <tr>
                                    <td>{{ attendance.student.first_name }} {{ attendance.student.last_name }}</td>
                                    <td>
                                        <span class="attendance-status attendance-{{ attendance.status }}"></span>
                                        {{ attendance.get_status_display }}
                                    </td>
                                    <td>{{ attendance.attendance_time|date:"g:i A" }}</td>
                                    <td>{{ attendance.notes|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard fa-2x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No attendance records yet</p>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Makeup Sessions -->
        <div class="card class-meta-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-arrows-turn-to-dots me-2 text-warning"></i>Makeup Sessions</h5>
                {% if can_manage_makeup %}
                <button class="btn btn-sm btn-outline-warning" onclick="openMakeupModalFromTarget()">
                    <i class="fas fa-plus me-1"></i>New Makeup
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if source_makeup_sessions or target_makeup_sessions %}
                    <div class="table-responsive">
                        <table class="table table-sm align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Direction</th>
                                    <th>Counterpart Class</th>
                                    <th>Status</th>
                                    {% if can_manage_makeup %}
                                    <th>Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for makeup in source_makeup_sessions %}
                                <tr>
                                    <td>{{ makeup.student.first_name }} {{ makeup.student.last_name }}</td>
                                    <td><span class="badge bg-warning text-dark">Source</span></td>
                                    <td>{{ makeup.target_class.course.name }} | {{ makeup.target_class.date|date:"d/m/Y" }} {{ makeup.target_class.start_time|time:"g:i A" }}</td>
                                    <td><span class="badge bg-secondary">{{ makeup.get_status_display }}</span></td>
                                    {% if can_manage_makeup %}
                                    <td>
                                        {% if makeup.status == 'scheduled' %}
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-success" onclick="updateMakeupStatus({{ makeup.id }}, 'completed')">Complete</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateMakeupStatus({{ makeup.id }}, 'no_show')">No Show</button>
                                            <button type="button" class="btn btn-outline-danger" onclick="updateMakeupStatus({{ makeup.id }}, 'cancelled')">Cancel</button>
                                        </div>
                                        {% else %}
                                        <span class="text-muted small">Closed</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                                {% for makeup in target_makeup_sessions %}
                                <tr>
                                    <td>{{ makeup.student.first_name }} {{ makeup.student.last_name }}</td>
                                    <td><span class="badge bg-info text-dark">Target</span></td>
                                    <td>{{ makeup.source_class.course.name }} | {{ makeup.source_class.date|date:"d/m/Y" }} {{ makeup.source_class.start_time|time:"g:i A" }}</td>
                                    <td><span class="badge bg-secondary">{{ makeup.get_status_display }}</span></td>
                                    {% if can_manage_makeup %}
                                    <td>
                                        {% if makeup.status == 'scheduled' %}
                                        <div class="btn-group btn-group-sm">
                                            <button type="button" class="btn btn-outline-success" onclick="updateMakeupStatus({{ makeup.id }}, 'completed')">Complete</button>
                                            <button type="button" class="btn btn-outline-secondary" onclick="updateMakeupStatus({{ makeup.id }}, 'no_show')">No Show</button>
                                            <button type="button" class="btn btn-outline-danger" onclick="updateMakeupStatus({{ makeup.id }}, 'cancelled')">Cancel</button>
                                        </div>
                                        {% else %}
                                        <span class="text-muted small">Closed</span>
                                        {% endif %}
                                    </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted mb-0">No makeup sessions for this class yet.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Class Stats -->
        <div class="card class-meta-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2 text-primary"></i>Class Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-3 p-3">
                            <h4 class="text-primary mb-1">{{ class_students|length }}</h4>
                            <small class="text-muted">Students</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3">
                            <h4 class="text-success mb-1">{{ attendance_stats.present|default:0 }}</h4>
                            <small class="text-muted">Present</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3 p-3">
                            <h4 class="text-warning mb-1">{{ attendance_stats.late|default:0 }}</h4>
                            <small class="text-muted">Late</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded-3 p-3">
                            <h4 class="text-danger mb-1">{{ attendance_stats.absent|default:0 }}</h4>
                            <small class="text-muted">Absent</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Information -->
        <div class="card class-meta-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-book-open me-2 text-primary"></i>Course Context</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block">Course</small>
                    <strong>{{ class.course.name }}</strong>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block">Course Type</small>
                    <span class="badge bg-info">{{ class.course.get_course_type_display }}</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block">Total Sessions</small>
                    <strong>{{ class.course.classes.count }}</strong>
                </div>
                <div class="mb-0">
                    <small class="text-muted d-block">Course Status</small>
                    <span class="status-badge status-{{ class.course.status }}">
                        {% if class.course.status == 'published' %}Published
                        {% elif class.course.status == 'draft' %}Draft
                        {% elif class.course.status == 'expired' %}Expired
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Makeup Modal -->
<div class="modal fade" id="scheduleMakeupModal" tabindex="-1" aria-labelledby="scheduleMakeupModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scheduleMakeupModalLabel">Schedule Makeup Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="makeupInitiatedFrom" value="source">
                <input type="hidden" id="makeupStudentId" value="">

                <div class="alert alert-light border mb-3">
                    <strong>Current mode:</strong> <span id="makeupModeLabel">From Source Class</span>
                </div>

                <div class="mb-3">
                    <label for="makeupStudentSearch" class="form-label">Student</label>
                    <input type="text" class="form-control" id="makeupStudentSearch" placeholder="Search student name or email...">
                    <div id="makeupStudentSearchResults" class="list-group mt-2"></div>
                    <div class="form-text" id="makeupStudentHint">Select an existing student from the student list. New students must be created in Student Management first.</div>
                </div>

                <div class="mb-3" id="makeupSelectedStudentBox" style="display: none;">
                    <div class="card border-primary-subtle">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="badge bg-primary">Selected Student</span>
                                <div class="d-flex align-items-center gap-2">
                                    <span class="badge bg-success">Locked</span>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="unlockMakeupStudent()">
                                        Change
                                    </button>
                                </div>
                            </div>
                            <div class="fw-semibold" id="makeupSelectedStudentName"></div>
                            <div class="small text-muted" id="makeupSelectedStudentMeta"></div>
                            <div class="mt-2" id="makeupSelectedStudentCourses"></div>
                        </div>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="makeupSourceClass" class="form-label">Source Class</label>
                        <select class="form-select" id="makeupSourceClass">
                            <option value="">Select source class...</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="makeupTargetClass" class="form-label">Target Class</label>
                        <select class="form-select" id="makeupTargetClass">
                            <option value="">Select target class...</option>
                        </select>
                    </div>
                </div>
                <div class="form-text mt-2" id="makeupClassHint">
                    Select a student first to load source/target class options from the student's active enrolments and attendance history.
                </div>

                <div class="row g-3 mt-1">
                    <div class="col-md-6">
                        <label for="makeupReasonType" class="form-label">Reason</label>
                        <select class="form-select" id="makeupReasonType">
                            {% for value, label in makeup_reason_choices %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="makeupNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="makeupNotes" rows="2" placeholder="Optional notes for audit"></textarea>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="{% url 'students:student_list' %}" class="btn btn-outline-secondary">
                    <i class="fas fa-users me-1"></i>Open Student List
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="scheduleMakeupSubmitBtn" onclick="submitMakeupSession()" disabled>
                    <i class="fas fa-check me-1"></i>Schedule Makeup
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let makeupStudentSearchTimeout;
let makeupCandidatesPayload = null;
const CAN_MANAGE_MAKEUP = {{ can_manage_makeup|yesno:'true,false' }};

const CURRENT_CLASS_ID = '{{ class.pk }}';
const CURRENT_CLASS_LABEL = '{{ class.course.name|escapejs }} | {{ class.date|date:"d/m/Y" }} {{ class.start_time|time:"g:i A" }}';

function openMakeupModalFromSource(studentId, studentName) {
    if (!CAN_MANAGE_MAKEUP) {
        return;
    }
    document.getElementById('makeupInitiatedFrom').value = 'source';
    document.getElementById('makeupModeLabel').textContent = 'From Source Class';
    configureMakeupMode('source');
    resetMakeupStudentSelection();
    if (studentId) {
        setMakeupStudent(studentId, studentName);
    }
    const modal = new bootstrap.Modal(document.getElementById('scheduleMakeupModal'));
    modal.show();
}

function openMakeupModalFromTarget() {
    if (!CAN_MANAGE_MAKEUP) {
        return;
    }
    document.getElementById('makeupInitiatedFrom').value = 'target';
    document.getElementById('makeupModeLabel').textContent = 'From Target Class';
    configureMakeupMode('target');
    resetMakeupStudentSelection();
    const modal = new bootstrap.Modal(document.getElementById('scheduleMakeupModal'));
    modal.show();
}

function configureMakeupMode(mode) {
    const sourceSelect = document.getElementById('makeupSourceClass');
    const targetSelect = document.getElementById('makeupTargetClass');
    const hint = document.getElementById('makeupClassHint');

    if (mode === 'source') {
        setLockedClassSelect(sourceSelect, CURRENT_CLASS_ID, CURRENT_CLASS_LABEL);
        setPlaceholderOnly(targetSelect, 'Select target class...');
        targetSelect.disabled = true;
        hint.textContent = 'Select a student to load all upcoming active classes as target options.';
    } else {
        setLockedClassSelect(targetSelect, CURRENT_CLASS_ID, CURRENT_CLASS_LABEL);
        setPlaceholderOnly(sourceSelect, 'Select source class...');
        sourceSelect.disabled = true;
        hint.textContent = 'Select a student first. Source classes will be loaded from that student\'s enrolment, attendance and makeup history.';
    }

    updateMakeupSubmitState();
}

function setLockedClassSelect(selectElement, classId, label) {
    selectElement.innerHTML = '';
    const option = document.createElement('option');
    option.value = classId;
    option.textContent = label;
    option.selected = true;
    selectElement.appendChild(option);
    selectElement.disabled = true;
}

function setPlaceholderOnly(selectElement, placeholderText) {
    selectElement.innerHTML = '';
    const option = document.createElement('option');
    option.value = '';
    option.textContent = placeholderText;
    option.selected = true;
    selectElement.appendChild(option);
}

function resetMakeupStudentSelection() {
    makeupCandidatesPayload = null;
    const searchInput = document.getElementById('makeupStudentSearch');
    document.getElementById('makeupStudentId').value = '';
    searchInput.value = '';
    searchInput.readOnly = false;
    document.getElementById('makeupSelectedStudentName').textContent = '';
    document.getElementById('makeupSelectedStudentMeta').textContent = '';
    document.getElementById('makeupSelectedStudentCourses').innerHTML = '';
    document.getElementById('makeupSelectedStudentBox').style.display = 'none';
    document.getElementById('makeupStudentSearchResults').innerHTML = '';
    document.getElementById('makeupNotes').value = '';
    document.getElementById('makeupStudentHint').textContent =
        'Select an existing student from the student list. New students must be created in Student Management first.';
    updateMakeupSubmitState();
}

function unlockMakeupStudent() {
    resetMakeupStudentSelection();
    configureMakeupMode(document.getElementById('makeupInitiatedFrom').value);
    document.getElementById('makeupStudentSearch').focus();
}

function setMakeupStudent(studentId, studentName) {
    const searchInput = document.getElementById('makeupStudentSearch');
    document.getElementById('makeupStudentId').value = studentId;
    document.getElementById('makeupSelectedStudentName').textContent = studentName;
    document.getElementById('makeupSelectedStudentBox').style.display = 'block';
    document.getElementById('makeupStudentSearchResults').innerHTML = '';
    searchInput.value = studentName;
    searchInput.readOnly = true;
    document.getElementById('makeupStudentHint').textContent =
        'Student is locked to keep source/target classes consistent. Click Change if needed.';
    loadMakeupCandidates(studentId);
}

function initMakeupStudentSearch() {
    const searchInput = document.getElementById('makeupStudentSearch');
    if (!searchInput) return;

    searchInput.addEventListener('input', function () {
        if (this.readOnly) {
            return;
        }
        const query = this.value.trim();
        clearTimeout(makeupStudentSearchTimeout);

        if (query.length < 2) {
            document.getElementById('makeupStudentSearchResults').innerHTML = '';
            return;
        }

        makeupStudentSearchTimeout = setTimeout(() => {
            fetch(`/students/search/?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(response => response.json())
                .then(data => renderMakeupStudentSearchResults(data.students || []))
                .catch(() => {
                    document.getElementById('makeupStudentSearchResults').innerHTML = '';
                });
        }, 250);
    });
}

function renderMakeupStudentSearchResults(students) {
    const container = document.getElementById('makeupStudentSearchResults');
    if (!students.length) {
        container.innerHTML = '<div class="list-group-item text-muted">No matching students found.</div>';
        return;
    }

    container.innerHTML = students.map(student => `
        <button type="button" class="list-group-item list-group-item-action"
            data-student-name="${`${student.first_name} ${student.last_name}`.replace(/"/g, '&quot;')}"
            onclick="setMakeupStudent(${student.id}, this.dataset.studentName)">
            <div class="fw-medium">${student.first_name} ${student.last_name}</div>
            <small class="text-muted">${student.email || student.contact_email || 'No email'}</small>
        </button>
    `).join('');
}

function loadMakeupCandidates(studentId) {
    const initiatedFrom = document.getElementById('makeupInitiatedFrom').value;
    const hint = document.getElementById('makeupClassHint');
    hint.textContent = 'Loading class options...';

    fetch(`{% url "academics:class_makeup_candidates" class.pk %}?student_id=${encodeURIComponent(studentId)}&initiated_from=${encodeURIComponent(initiatedFrom)}`, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
    })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                hint.textContent = data.message || 'Unable to load classes for selected student.';
                return;
            }
            makeupCandidatesPayload = data;
            applyCandidatePayload(data);
        })
        .catch(() => {
            hint.textContent = 'Unable to load classes. Please try again.';
        });
}

function applyCandidatePayload(payload) {
    const mode = document.getElementById('makeupInitiatedFrom').value;
    const sourceSelect = document.getElementById('makeupSourceClass');
    const targetSelect = document.getElementById('makeupTargetClass');
    const hint = document.getElementById('makeupClassHint');
    const student = payload.student || {};

    document.getElementById('makeupSelectedStudentName').textContent = student.name || '';
    const email = student.email ? `Email: ${student.email}` : 'Email: N/A';
    const phone = student.phone ? `Phone: ${student.phone}` : 'Phone: N/A';
    document.getElementById('makeupSelectedStudentMeta').textContent = `${email} | ${phone}`;

    const coursesContainer = document.getElementById('makeupSelectedStudentCourses');
    const activeCourses = student.active_courses || [];
    if (activeCourses.length) {
        coursesContainer.innerHTML = activeCourses
            .map(courseName => `<span class="badge bg-light text-dark border me-1 mb-1">${courseName}</span>`)
            .join('');
    } else {
        coursesContainer.innerHTML = '<span class="badge bg-light text-muted border">No active enrolments</span>';
    }

    if (mode === 'source') {
        setLockedClassSelect(sourceSelect, payload.current_class.id, payload.current_class.label);
        populateClassSelect(targetSelect, payload.candidates, 'Select target class...');
        targetSelect.disabled = payload.candidates.length === 0;
    } else {
        setLockedClassSelect(targetSelect, payload.current_class.id, payload.current_class.label);
        populateClassSelect(sourceSelect, payload.candidates, 'Select source class...');
        sourceSelect.disabled = payload.candidates.length === 0;
    }

    if (!payload.candidates.length) {
        if (mode === 'target') {
            setPlaceholderOnly(sourceSelect, 'No Available Class');
            sourceSelect.disabled = true;
        } else {
            setPlaceholderOnly(targetSelect, 'No Available Class');
            targetSelect.disabled = true;
        }
        hint.textContent = mode === 'source'
            ? 'No upcoming active target classes are available right now.'
            : 'No source classes were found for this student. Check enrolment/attendance history first.';
    } else {
        hint.textContent = mode === 'source'
            ? 'Target options show all upcoming active classes across courses, sorted by time.'
            : 'Source options are loaded from the selected student\'s enrolment, attendance and makeup history.';
    }

    updateMakeupSubmitState();
}

function populateClassSelect(selectElement, classes, placeholder) {
    setPlaceholderOnly(selectElement, placeholder);
    classes.forEach(classOption => {
        const option = document.createElement('option');
        option.value = classOption.id;
        option.textContent = classOption.label;
        selectElement.appendChild(option);
    });
}

function updateMakeupSubmitState() {
    const submitBtn = document.getElementById('scheduleMakeupSubmitBtn');
    const hasStudent = !!document.getElementById('makeupStudentId').value;
    const sourceClassId = document.getElementById('makeupSourceClass').value;
    const targetClassId = document.getElementById('makeupTargetClass').value;
    submitBtn.disabled = !(hasStudent && sourceClassId && targetClassId);
}

function submitMakeupSession() {
    if (!CAN_MANAGE_MAKEUP) {
        alert('Only administrators can manage makeup sessions.');
        return;
    }

    const initiatedFrom = document.getElementById('makeupInitiatedFrom').value;
    const studentId = document.getElementById('makeupStudentId').value;
    const sourceClassId = document.getElementById('makeupSourceClass').value;
    const targetClassId = document.getElementById('makeupTargetClass').value;
    const reasonType = document.getElementById('makeupReasonType').value;
    const notes = document.getElementById('makeupNotes').value;

    if (!studentId) {
        alert('Please select a student from the list.');
        return;
    }
    if (!sourceClassId) {
        alert('Please select the source class.');
        return;
    }
    if (!targetClassId) {
        alert('Please select the target class.');
        return;
    }

    const submitBtn = document.getElementById('scheduleMakeupSubmitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Scheduling...';

    fetch('{% url "academics:class_schedule_makeup" class.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
            initiated_from: initiatedFrom,
            student_id: studentId,
            source_class_id: sourceClassId,
            target_class_id: targetClassId,
            reason_type: reasonType,
            notes: notes,
        }),
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
                return;
            }
            alert(`Error: ${data.message}`);
        })
        .catch(() => {
            alert('An error occurred while scheduling makeup. Please try again.');
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-check me-1"></i>Schedule Makeup';
        });
}

function updateMakeupStatus(makeupSessionId, nextStatus) {
    if (!CAN_MANAGE_MAKEUP) {
        alert('Only administrators can manage makeup sessions.');
        return;
    }

    let notes = '';
    if (nextStatus === 'cancelled') {
        notes = window.prompt('Please enter a cancellation reason:');
        if (notes === null) {
            return;
        }
        notes = notes.trim();
        if (!notes) {
            alert('Cancellation reason is required.');
            return;
        }
    } else {
        const actionLabel = nextStatus.replace('_', ' ');
        if (!window.confirm(`Mark this makeup session as ${actionLabel}?`)) {
            return;
        }
    }

    fetch('{% url "academics:class_update_makeup_status" class.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
            makeup_session_id: makeupSessionId,
            status: nextStatus,
            notes: notes,
        }),
    })
        .then(response => response.json().then(data => ({ ok: response.ok, data })))
        .then(({ ok, data }) => {
            if (!ok || !data.success) {
                alert(`Error: ${data.message || 'Unable to update makeup status.'}`);
                return;
            }
            alert(data.message);
            window.location.reload();
        })
        .catch(() => {
            alert('An error occurred while updating makeup status. Please try again.');
        });
}

// Fix for dropdown z-index issue
document.addEventListener('DOMContentLoaded', function() {
    if (CAN_MANAGE_MAKEUP) {
        initMakeupStudentSearch();
        configureMakeupMode('source');

        document.getElementById('makeupSourceClass').addEventListener('change', updateMakeupSubmitState);
        document.getElementById('makeupTargetClass').addEventListener('change', updateMakeupSubmitState);
    }

    // Add event listeners to all dropdowns in the student list
    const dropdowns = document.querySelectorAll('.student-list-item .dropdown');
    
    dropdowns.forEach(dropdown => {
        dropdown.addEventListener('show.bs.dropdown', function () {
            // When dropdown opens, add class to parent row
            this.closest('.student-list-item').classList.add('z-index-active');
            const card = this.closest('.class-meta-card');
            if (card) card.classList.add('z-index-card-active');
        });
        
        dropdown.addEventListener('hidden.bs.dropdown', function () {
            // When dropdown closes, remove class from parent row
            this.closest('.student-list-item').classList.remove('z-index-active');
            const card = this.closest('.class-meta-card');
            if (card) card.classList.remove('z-index-card-active');
        });
    });
});
</script>
{% endblock %}
