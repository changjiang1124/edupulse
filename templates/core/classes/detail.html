{% extends 'base.html' %}
{% load static %}

{% block title %}{{ class.course.name }} - {{ class.date }} - Class Details - EduPulse{% endblock %}

{% block extra_css %}
<style>
.class-hero {
    background: white;
    color: #374151;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #e2e8f0;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}
.class-meta-card {
    border: none;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    border-radius: 12px;
}
.class-meta-card .card-header {
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    border-radius: 12px 12px 0 0 !important;
}
.student-list-item {
    padding: 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.5rem;
    transition: all 0.2s ease;
    position: relative;
}
.student-list-item:hover {
    background-color: #f8fafc;
    transform: translateX(4px);
    z-index: 1;
}
.participation-badge {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 12px;
}
.participation-enrolled {
    background-color: #dbeafe;
    color: #1e40af;
}
.participation-pending {
    background-color: #fef3c7;
    color: #92400e;
}
.participation-temp {
    background-color: #fef3c7;
    color: #92400e;
}
.attendance-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}
.attendance-present {
    background-color: #10b981;
}
.attendance-absent {
    background-color: #ef4444;
}
.attendance-late {
    background-color: #f59e0b;
}
.attendance-pending {
    background-color: #6b7280;
}
.attendance-unmarked {
    background-color: #9ca3af;
}
.dropdown-menu {
    z-index: 1050 !important;
    position: absolute !important;
}

.z-index-active {
    z-index: 100 !important;
    position: relative;
    transform: none !important;
}
.z-index-card-active {
    z-index: 2000 !important;
    position: relative;
    transform: none !important;
}
</style>
{% endblock %}

{% block content %}
{% csrf_token %}
<!-- Standard Detail Page Header -->
<div class="mb-3">
    <a href="{% url 'academics:class_list' %}" class="text-decoration-none text-muted">
        <i class="fas fa-arrow-left me-2"></i>Back to Classes
    </a>
</div>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h2 fw-bold mb-2">{{ class.course.name }}</h1>
        <div class="text-muted mb-3">{{ class.date|date:"l, d F Y" }} at {{ class.start_time|time:"g:i A" }}</div>
        <div class="d-flex flex-wrap gap-2">
            <span class="badge bg-primary text-white px-3 py-2">
                <i class="fas fa-clock me-1"></i>{{ class.duration_minutes }} minutes
            </span>
            {% if class.teacher %}
            <span class="badge bg-info text-white px-3 py-2">
                <i class="fas fa-user-tie me-1"></i>{{ class.teacher.first_name }} {{ class.teacher.last_name }}
            </span>
            {% endif %}
            {% if class.classroom %}
            <span class="badge bg-warning text-dark px-3 py-2">
                <i class="fas fa-map-marker-alt me-1"></i>{{ class.classroom.name }}
            </span>
            {% endif %}
            <span class="badge {{ class.is_active|yesno:'bg-success,bg-secondary' }} text-white px-3 py-2">
                {{ class.is_active|yesno:'Active,Inactive' }}
            </span>
        </div>
    </div>
    <div class="d-flex flex-column gap-2">
        {% if user.role == 'admin' %}
        <a href="{% url 'academics:class_edit' class.pk %}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit Class
        </a>
        {% endif %}
        <a href="{% url 'academics:course_detail' class.course.pk %}" class="btn btn-outline-primary">
            <i class="fas fa-book me-2"></i>View Course
        </a>
    </div>
</div>

<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        
        <!-- Class Information -->
        <div class="card class-meta-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2 text-primary"></i>Class Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-primary me-3">
                                <i class="fas fa-book"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Course</small>
                                <strong>
                                    <a href="{% url 'academics:course_detail' class.course.pk %}" class="text-decoration-none">
                                        {{ class.course.name }}
                                    </a>
                                </strong>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-info me-3">
                                <i class="fas fa-calendar"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Date & Time</small>
                                <strong>{{ class.date|date:"d/m/Y" }} at {{ class.start_time|time:"g:i A" }}</strong>
                            </div>
                        </div>
                    </div>
                    
                    {% if class.teacher %}
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="avatar-circle bg-primary me-3">
                                {{ class.teacher.first_name|first }}{{ class.teacher.last_name|first }}
                            </div>
                            <div>
                                <small class="text-muted d-block">Instructor</small>
                                <strong>{{ class.teacher.first_name }} {{ class.teacher.last_name }}</strong>
                                {% if class.teacher != class.course.teacher %}
                                <br><small class="text-warning">
                                    <i class="fas fa-info-circle me-1"></i>Different from course teacher
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if class.classroom %}
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <div class="icon-circle bg-warning me-3">
                                <i class="fas fa-door-open"></i>
                            </div>
                            <div>
                                <small class="text-muted d-block">Location</small>
                                <strong>{{ class.classroom.name }}</strong>
                                {% if class.facility %}<br><small class="text-muted">{{ class.facility.name }}</small>{% endif %}
                                {% if class.classroom != class.course.classroom %}
                                <br><small class="text-warning">
                                    <i class="fas fa-info-circle me-1"></i>Different from course classroom
                                </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Students in This Class -->
        <div class="card class-meta-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-users me-2 text-primary"></i>
                    Students <span class="badge bg-primary ms-2">{{ class_students|length }}</span>
                </h5>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                        <i class="fas fa-user-plus me-1"></i>Add Student
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if class_students %}
                    {% for student_info in class_students %}
                    <div class="student-list-item border">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <div class="d-flex align-items-center">
                                    <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-3">
                                        {{ student_info.student.first_name|first }}{{ student_info.student.last_name|first }}
                                    </div>
                                    <div>
                                        <div class="fw-medium">{{ student_info.student.first_name }} {{ student_info.student.last_name }}</div>
                                        <small class="text-muted">{{ student_info.student.contact_email|default:"No email" }}</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <span class="participation-badge participation-{{ student_info.participation_type }}">
                                    {% if student_info.participation_type == 'enrolled' %}
                                        <i class="fas fa-user-check me-1"></i>{{ student_info.enrollment_status_display|default:"Enrolled" }}
                                    {% elif student_info.participation_type == 'pending' %}
                                        <i class="fas fa-hourglass-half me-1"></i>{{ student_info.enrollment_status_display|default:"Pending" }}
                                    {% elif student_info.participation_type == 'temp' %}
                                        <i class="fas fa-user-clock me-1"></i>Temporary
                                    {% else %}
                                        <i class="fas fa-user-plus me-1"></i>Added
                                    {% endif %}
                                </span>
                            </div>
                            <div class="col-md-2">
                                {% with student_info.attendance_status as status %}
                                <div class="attendance-status attendance-{{ status|default:'pending' }}"></div>
                                <small class="text-muted">
                                    {% if status == 'present' %}Present
                                    {% elif status == 'absent' %}Absent
                                    {% elif status == 'late' %}Late
                                    {% elif status == 'unmarked' %}Unmarked
                                    {% else %}Pending
                                    {% endif %}
                                </small>
                                {% endwith %}
                            </div>
                            <div class="col-md-1">
                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="dropdown">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{% url 'students:student_detail' student_info.student.pk %}">View Student</a></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="removeStudent({{ student_info.student.pk }})">Remove from Class</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-user-plus fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No students assigned</h6>
                        <p class="text-muted mb-3">Add students to this class to get started</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                            <i class="fas fa-user-plus me-2"></i>Add First Student
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Attendance History -->
        <div class="card class-meta-card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-clipboard-check me-2 text-primary"></i>Attendance History</h5>
                <a href="{% url 'enrollment:attendance_mark' class.pk %}" class="btn btn-sm btn-success">
                    <i class="fas fa-check me-1"></i>Mark Attendance
                </a>
            </div>
            <div class="card-body">
                {% if attendances %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Student</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in attendances %}
                                <tr>
                                    <td>{{ attendance.student.first_name }} {{ attendance.student.last_name }}</td>
                                    <td>
                                        <span class="attendance-status attendance-{{ attendance.status }}"></span>
                                        {{ attendance.get_status_display }}
                                    </td>
                                    <td>{{ attendance.attendance_time|date:"g:i A" }}</td>
                                    <td>{{ attendance.notes|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-clipboard fa-2x text-muted mb-3"></i>
                        <p class="text-muted mb-0">No attendance records yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Class Stats -->
        <div class="card class-meta-card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie me-2 text-primary"></i>Class Statistics</h5>
            </div>
            <div class="card-body">
                <div class="row g-3 text-center">
                    <div class="col-6">
                        <div class="bg-primary bg-opacity-10 border border-primary border-opacity-25 rounded-3 p-3">
                            <h4 class="text-primary mb-1">{{ class_students|length }}</h4>
                            <small class="text-muted">Students</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-success bg-opacity-10 border border-success border-opacity-25 rounded-3 p-3">
                            <h4 class="text-success mb-1">{{ attendance_stats.present|default:0 }}</h4>
                            <small class="text-muted">Present</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-warning bg-opacity-10 border border-warning border-opacity-25 rounded-3 p-3">
                            <h4 class="text-warning mb-1">{{ attendance_stats.late|default:0 }}</h4>
                            <small class="text-muted">Late</small>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="bg-danger bg-opacity-10 border border-danger border-opacity-25 rounded-3 p-3">
                            <h4 class="text-danger mb-1">{{ attendance_stats.absent|default:0 }}</h4>
                            <small class="text-muted">Absent</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Course Information -->
        <div class="card class-meta-card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-book-open me-2 text-primary"></i>Course Context</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block">Course</small>
                    <strong>{{ class.course.name }}</strong>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block">Course Type</small>
                    <span class="badge bg-info">{{ class.course.get_course_type_display }}</span>
                </div>
                <div class="mb-3">
                    <small class="text-muted d-block">Total Sessions</small>
                    <strong>{{ class.course.classes.count }}</strong>
                </div>
                <div class="mb-0">
                    <small class="text-muted d-block">Course Status</small>
                    <span class="status-badge status-{{ class.course.status }}">
                        {% if class.course.status == 'published' %}Published
                        {% elif class.course.status == 'draft' %}Draft
                        {% elif class.course.status == 'expired' %}Expired
                        {% endif %}
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Student to Class</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="studentSearch" class="form-label">Search Students</label>
                    <input type="text" class="form-control" id="studentSearch" placeholder="Type student name or email...">
                </div>
                <div id="studentSearchResults" class="mb-3">
                    <!-- Student search results will be populated here -->
                </div>
                <div class="text-center mb-3" id="addNewStudentOption" style="display: none;">
                    <hr>
                    <p class="text-muted">Can't find the student you're looking for?</p>
                    <a href="{% url 'students:student_add' %}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-user-plus me-1"></i>Add New Student
                    </a>
                </div>
                <div class="mt-3">
                    <label for="participationType" class="form-label">Participation Type</label>
                    <select class="form-select" id="participationType">
                        <option value="enrolled">Enrolled (Regular student)</option>
                        <option value="temp">Temporary (One-time participant)</option>
                        <option value="makeup">Makeup Class</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addStudentsBtn" onclick="addSelectedStudents()">Add Students</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let selectedStudents = [];

function removeStudent(studentId) {
    if (confirm('Are you sure you want to remove this student from the class?')) {
        // Implement remove student functionality
        // This would make an AJAX call to remove the student
        console.log('Remove student:', studentId);
    }
}

function addSelectedStudents() {
    if (selectedStudents.length === 0) {
        alert('Please select at least one student.');
        return;
    }
    
    const participationType = document.getElementById('participationType').value;
    const studentIds = selectedStudents.map(s => s.id);
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // Disable the button to prevent double-clicks
    const addButton = document.getElementById('addStudentsBtn');
    addButton.disabled = true;
    addButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Adding...';
    
    // Make AJAX call to add students
    fetch('{% url "academics:class_add_students" class.pk %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest',
        },
        body: JSON.stringify({
            student_ids: studentIds,
            participation_type: participationType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            alert(data.message);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addStudentModal'));
            modal.hide();
            
            // Reload page to show updated student list
            window.location.reload();
        } else {
            // Show error message
            alert('Error: ' + data.message);
            
            // Re-enable button
            addButton.disabled = false;
            addButton.innerHTML = 'Add Students';
        }
    })
    .catch(error => {
        console.error('Error adding students:', error);
        alert('An error occurred while adding students. Please try again.');
        
        // Re-enable button
        addButton.disabled = false;
        addButton.innerHTML = 'Add Students';
    });
}


function toggleStudentSelection(studentId, studentName) {
    const index = selectedStudents.findIndex(s => s.id === studentId);
    if (index === -1) {
        selectedStudents.push({id: studentId, name: studentName});
    } else {
        selectedStudents.splice(index, 1);
    }
    
    // Update visual feedback
    const checkbox = document.querySelector(`input[data-student-id="${studentId}"]`);
    if (checkbox) {
        checkbox.checked = index === -1;
    }
    
    console.log('Selected students:', selectedStudents);
}

// Student search functionality with debouncing
let searchTimeout;
document.getElementById('studentSearch').addEventListener('input', function() {
    const query = this.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length >= 2) {
        searchTimeout = setTimeout(() => {
            searchStudents(query);
        }, 300);
    } else {
        document.getElementById('studentSearchResults').innerHTML = '';
        document.getElementById('addNewStudentOption').style.display = 'none';
    }
});

function searchStudents(query) {
    // Make AJAX call to search for students
    fetch(`/students/search/?q=${encodeURIComponent(query)}`, {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        displaySearchResults(data.students, query);
    })
    .catch(error => {
        console.error('Search error:', error);
        displaySearchResults([], query);
    });
}

function displaySearchResults(students, query) {
    const resultsContainer = document.getElementById('studentSearchResults');
    const addNewOption = document.getElementById('addNewStudentOption');
    
    if (students.length === 0) {
        resultsContainer.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-search me-2"></i>No students found matching "${query}"
            </div>
        `;
        addNewOption.style.display = 'block';
    } else {
        let html = '<div class="list-group">';
        students.forEach(student => {
            const isSelected = selectedStudents.some(s => s.id === student.id);
            html += `
                <div class="list-group-item list-group-item-action">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               data-student-id="${student.id}" 
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleStudentSelection(${student.id}, '${student.first_name} ${student.last_name}')">
                        <label class="form-check-label w-100" style="cursor: pointer;">
                            <div class="d-flex align-items-center">
                                <div class="avatar-circle bg-primary bg-opacity-10 text-primary me-3">
                                    ${student.first_name[0]}${student.last_name[0]}
                                </div>
                                <div>
                                    <div class="fw-medium">${student.first_name} ${student.last_name}</div>
                                    <small class="text-muted">${student.contact_email || 'No email'}</small>
                                </div>
                            </div>
                        </label>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        resultsContainer.innerHTML = html;
        addNewOption.style.display = 'block';
    }
}

// Fix for dropdown z-index issue
document.addEventListener('DOMContentLoaded', function() {
    // Add event listeners to all dropdowns in the student list
    const dropdowns = document.querySelectorAll('.student-list-item .dropdown');
    
    dropdowns.forEach(dropdown => {
        dropdown.addEventListener('show.bs.dropdown', function () {
            // When dropdown opens, add class to parent row
            this.closest('.student-list-item').classList.add('z-index-active');
            const card = this.closest('.class-meta-card');
            if (card) card.classList.add('z-index-card-active');
        });
        
        dropdown.addEventListener('hidden.bs.dropdown', function () {
            // When dropdown closes, remove class from parent row
            this.closest('.student-list-item').classList.remove('z-index-active');
            const card = this.closest('.class-meta-card');
            if (card) card.classList.remove('z-index-card-active');
        });
    });
});
</script>
{% endblock %}
