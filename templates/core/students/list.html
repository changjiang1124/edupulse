{% extends 'base.html' %}
{% load static %}

{% block title %}Students - EduPulse{% endblock %}

{% block extra_css %}
<style>
    .tag-badge {
        font-size: 0.75rem;
        margin-right: 2px;
        margin-bottom: 2px;
    }
    .student-checkbox {
        cursor: pointer;
    }
    .clickable-row.selected {
        background-color: #e3f2fd !important;
    }

    /* Tag filter styles */
    .tag-filter-container {
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.75rem;
        background-color: #f8f9fa;
    }

    .tag-filters-wrapper {
        max-height: 120px;
        overflow-y: auto;
        margin-bottom: 0.5rem;
    }

    .tag-filters-wrapper .form-check-inline {
        margin-bottom: 0.25rem;
    }

    .tag-filter-controls {
        border-top: 1px solid #dee2e6;
        padding-top: 0.5rem;
    }

    /* Compact bulk actions styles */
    .gap-3 {
        gap: 1rem !important;
    }

    .gap-2 {
        gap: 0.5rem !important;
    }

    #bulkActionsCompact {
        border-left: 1px solid #dee2e6;
        padding-left: 1rem;
    }

    /* Tag selection in modal */
    .tag-selection-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .tag-selection-item:hover {
        background-color: #f8f9fa;
    }

    .tag-selection-item.selected {
        background-color: #e3f2fd;
        border-color: #1976d2;
    }

    .tag-selection-item .tag-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tag-count {
        font-size: 0.875rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <h1 class="page-title">Student Management</h1>
        <p class="page-subtitle">Manage student profiles and information</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="{% url 'students:student_add' %}" class="btn btn-primary">Add New Student</a>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="get" class="row g-3" id="searchForm">
                    <div class="col-md-6">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" name="search" id="search" class="form-control" 
                               placeholder="Search students by name, email, or guardian name..." value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Filter by Tags</label>
                        <div class="tag-filter-container">
                            <div class="tag-filters-wrapper" id="tagFiltersWrapper">
                                {% for tag in student_tags %}
                                <div class="form-check form-check-inline">
                                    <input type="checkbox"
                                           class="form-check-input tag-filter-checkbox"
                                           name="tags"
                                           value="{{ tag.id }}"
                                           id="tag_{{ tag.id }}"
                                           {% if tag.id in selected_tag_ids %}checked{% endif %}
                                           onchange="updateTagFilter()">
                                    <label class="form-check-label" for="tag_{{ tag.id }}">
                                        <span class="badge" style="background-color: {{ tag.colour }};">
                                            {{ tag.name }}
                                        </span>
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                            {% if student_tags %}
                            <div class="tag-filter-controls mt-2">
                                <button type="button" class="btn btn-link btn-sm p-0" onclick="clearAllTagFilters()">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                                <span class="mx-2">|</span>
                                <small class="text-muted">
                                    <span id="selectedTagCount">{{ selected_tag_ids|length }}</span>
                                    tag{{ selected_tag_ids|length|pluralize }} selected
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary w-100">Search</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Students List -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Students ({{ students|length }})</h5>
                <div class="d-flex align-items-center gap-3">
                    <!-- Compact Bulk Actions (initially hidden) -->
                    <div id="bulkActionsCompact" class="d-flex align-items-center gap-2" style="display: none;">
                        <span class="text-muted small">
                            <span id="selectedCountCompact">0</span> selected
                        </span>
                        <select id="bulkActionSelect" class="form-select form-select-sm" style="min-width: 140px;">
                            <option value="">Choose action...</option>
                            <option value="add_tag">Add Tag</option>
                            <option value="remove_tag">Remove Tag</option>
                            <option value="send_notification">Send Notification</option>
                        </select>
                        <button type="button" id="bulkApplyBtn" class="btn btn-sm btn-primary" onclick="handleBulkAction()">
                            Apply
                        </button>
                    </div>
                    <!-- Select All Area -->
                    <div>
                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleAllStudents(this)">
                        <label class="form-check-label ms-2" for="selectAllCheckbox">Select All</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if students %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="40px">
                                        <i class="fas fa-check-square text-muted"></i>
                                    </th>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Guardian</th>
                                    <th>Tags</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr class="clickable-row" data-href="{% url 'students:student_detail' student.pk %}" data-student-id="{{ student.pk }}" id="student-row-{{ student.pk }}">
                                    <td>
                                        <input type="checkbox" class="form-check-input student-checkbox" 
                                               value="{{ student.pk }}" onchange="toggleStudentSelection({{ student.pk }}, this.checked)"
                                               onclick="event.stopPropagation()">
                                    </td>
                                    <td>
                                        <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                        {% if student.birth_date %}
                                            <br><small class="text-muted">Born: {{ student.birth_date|date:"d/m/Y" }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if student.contact_email %}
                                            <div><i class="fas fa-envelope text-muted"></i> {{ student.contact_email }}</div>
                                        {% endif %}
                                        {% if student.contact_phone %}
                                            <div><i class="fas fa-phone text-muted"></i> {{ student.contact_phone }}</div>
                                        {% endif %}
                                        {% if not student.contact_email and not student.contact_phone %}
                                            <span class="text-muted">No contact info</span>
                                        {% endif %}
                                        {% if student.guardian_name %}
                                            <br><small class="text-muted"><i class="fas fa-user-friends"></i> Guardian contact</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if student.guardian_name %}
                                            <strong>{{ student.guardian_name }}</strong>
                                            <br><small class="text-muted">Student is {{ student.get_age|default:"unknown" }} years old</small>
                                        {% else %}
                                            <span class="text-muted">No guardian info</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for tag in student.tags.all %}
                                            <span class="badge tag-badge" style="background-color: {{ tag.colour }};">
                                                {{ tag.name }}
                                            </span>
                                        {% empty %}
                                            <span class="text-muted">No tags</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="status-badge {% if student.is_active %}status-active{% else %}status-inactive{% endif %}">
                                            {% if student.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'students:student_detail' student.pk %}" 
                                               class="btn btn-outline-primary btn-sm">View</a>
                                            <a href="{% url 'students:student_edit' student.pk %}" 
                                               class="btn btn-outline-secondary btn-sm">Edit</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                    <nav aria-label="Student pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-3">No students found.</p>
                        <a href="{% url 'students:student_add' %}" class="btn btn-primary">Add First Student</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bulk Notification Modal -->
<div class="modal fade" id="bulkNotificationModal" tabindex="-1" aria-labelledby="bulkNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkNotificationModalLabel">Send Bulk Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'students:bulk_notification' %}" id="bulkNotificationForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="student_ids" id="selectedStudentIds">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Recipients:</strong> <span id="recipientCount">0</span> students selected
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationType" class="form-label">Notification Type</label>
                                <select class="form-select" id="notificationType" name="notification_type" required>
                                    <option value="email">Email Only</option>
                                    <option value="sms">SMS Only</option>
                                    <option value="both">Both Email & SMS</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="messageType" class="form-label">Message Type</label>
                                <select class="form-select" id="messageType" name="message_type" required>
                                    <option value="general">General Message</option>
                                    <option value="course_reminder">Course Reminder</option>
                                    <option value="attendance_notice">Attendance Notice</option>
                                    <option value="welcome">Welcome Message</option>
                                    <option value="enrollment_confirm">Enrollment Confirmation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3" id="emailSubjectGroup">
                        <label for="emailSubject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="emailSubject" name="subject" 
                               placeholder="Enter email subject">
                    </div>
                    
                    <div class="mb-3">
                        <label for="messageContent" class="form-label">Message Content</label>
                        <textarea class="form-control" id="messageContent" name="message" rows="6" 
                                  placeholder="Enter your message here..." required></textarea>
                        <div class="form-text">
                            <span id="messageCounter">0</span> characters
                            <span id="smsWarning" class="text-warning" style="display: none;">
                                (SMS messages should be under 160 characters)
                            </span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Tag Operation Modal -->
<div class="modal fade" id="bulkTagModal" tabindex="-1" aria-labelledby="bulkTagModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkTagModalLabel">Bulk Tag Operation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Operation:</strong> <span id="tagOperationMode">Add</span> tags for <span id="tagRecipientCount">0</span> selected students
                </div>

                <div class="mb-3">
                    <label class="form-label">Select Tags:</label>
                    <div id="tagSelectionContainer" class="border rounded p-3" style="max-height: 200px; overflow-y: auto;">
                        <!-- Tags will be loaded here via AJAX -->
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading tags...
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">
                        <span id="selectedTagsCount">0</span> tag(s) selected for operation
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="performTagOperation" onclick="performBulkTagOperation()">
                    <i class="fas fa-tag"></i> <span id="tagOperationButtonText">Add Tags</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedStudents = new Set();
let availableTags = [];
let selectedTagsForOperation = new Set();
let currentTagOperation = 'add';

// Tag filtering functions
function updateTagFilter() {
    updateSelectedTagCount();
    // Auto-submit form when tag selection changes
    setTimeout(() => {
        document.getElementById('searchForm').submit();
    }, 100);
}

function updateSelectedTagCount() {
    const checkedTags = document.querySelectorAll('.tag-filter-checkbox:checked');
    document.getElementById('selectedTagCount').textContent = checkedTags.length;
}

function clearAllTagFilters() {
    document.querySelectorAll('.tag-filter-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedTagCount();
    document.getElementById('searchForm').submit();
}

// Bulk tag operation functions
async function openBulkTagModal(operation) {
    if (selectedStudents.size === 0) {
        alert('Please select at least one student first.');
        return;
    }

    currentTagOperation = operation;

    // Update modal UI
    document.getElementById('tagOperationMode').textContent = operation === 'add' ? 'Add' : 'Remove';
    document.getElementById('tagRecipientCount').textContent = selectedStudents.size;
    document.getElementById('tagOperationButtonText').textContent = operation === 'add' ? 'Add Tags' : 'Remove Tags';

    const performButton = document.getElementById('performTagOperation');
    performButton.className = operation === 'add' ? 'btn btn-success' : 'btn btn-warning';

    // Load available tags
    await loadAvailableTags();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('bulkTagModal'));
    modal.show();
}

async function loadAvailableTags() {
    try {
        const response = await fetch('{% url "students:get_available_tags" %}', {
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        const data = await response.json();

        if (data.success) {
            availableTags = data.tags;
            renderTagSelection();
        } else {
            throw new Error(data.error || 'Failed to load tags');
        }
    } catch (error) {
        console.error('Error loading tags:', error);
        document.getElementById('tagSelectionContainer').innerHTML =
            '<div class="text-danger">Error loading tags. Please try again.</div>';
    }
}

function renderTagSelection() {
    const container = document.getElementById('tagSelectionContainer');
    selectedTagsForOperation.clear();

    if (availableTags.length === 0) {
        container.innerHTML = '<div class="text-muted">No tags available.</div>';
        return;
    }

    let html = '';
    availableTags.forEach(tag => {
        html += `
            <div class="tag-selection-item" onclick="toggleTagForOperation(${tag.id})" id="tag-item-${tag.id}">
                <div class="tag-info">
                    <div>
                        <span class="badge" style="background-color: ${tag.colour};">
                            ${tag.name}
                        </span>
                    </div>
                    <div class="tag-count">
                        ${tag.student_count} students
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    updateSelectedTagsCount();
}

function toggleTagForOperation(tagId) {
    const tagItem = document.getElementById(`tag-item-${tagId}`);

    if (selectedTagsForOperation.has(tagId)) {
        selectedTagsForOperation.delete(tagId);
        tagItem.classList.remove('selected');
    } else {
        selectedTagsForOperation.add(tagId);
        tagItem.classList.add('selected');
    }

    updateSelectedTagsCount();
}

function updateSelectedTagsCount() {
    document.getElementById('selectedTagsCount').textContent = selectedTagsForOperation.size;
}

async function performBulkTagOperation() {
    if (selectedTagsForOperation.size === 0) {
        alert('Please select at least one tag for the operation.');
        return;
    }

    const performButton = document.getElementById('performTagOperation');
    const originalText = performButton.innerHTML;
    performButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    performButton.disabled = true;

    try {
        const formData = new FormData();
        formData.append('student_ids', Array.from(selectedStudents).join(','));
        formData.append('operation', currentTagOperation);
        formData.append('tag_ids', Array.from(selectedTagsForOperation).join(','));

        const response = await fetch('{% url "students:bulk_tag_operation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(`Success! ${data.message}`);

            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('bulkTagModal')).hide();

            // Refresh the page to show updated tags
            window.location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Error performing bulk tag operation:', error);
        alert('An error occurred while performing the operation. Please try again.');
    } finally {
        performButton.innerHTML = originalText;
        performButton.disabled = false;
    }
}

function toggleStudentSelection(studentId, checked) {
    const row = document.getElementById(`student-row-${studentId}`);

    if (checked) {
        selectedStudents.add(studentId);
        row.classList.add('selected');
    } else {
        selectedStudents.delete(studentId);
        row.classList.remove('selected');
    }

    updateCompactBulkActions();
    updateSelectAllCheckbox();
}

function toggleAllStudents(checkbox) {
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');

    studentCheckboxes.forEach(cb => {
        const studentId = parseInt(cb.value);
        const row = document.getElementById(`student-row-${studentId}`);

        cb.checked = checkbox.checked;

        if (checkbox.checked) {
            selectedStudents.add(studentId);
            row.classList.add('selected');
        } else {
            selectedStudents.delete(studentId);
            row.classList.remove('selected');
        }
    });

    updateCompactBulkActions();
}

function updateCompactBulkActions() {
    const compactActions = document.getElementById('bulkActionsCompact');
    const countSpan = document.getElementById('selectedCountCompact');

    countSpan.textContent = selectedStudents.size;

    if (selectedStudents.size > 0) {
        compactActions.style.display = 'flex';
    } else {
        compactActions.style.display = 'none';
        // Reset the action selection when no students selected
        document.getElementById('bulkActionSelect').value = '';
    }
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const visibleCheckboxes = document.querySelectorAll('.student-checkbox');
    const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');

    if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedBoxes.length === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }
}

function handleBulkAction() {
    const selectedAction = document.getElementById('bulkActionSelect').value;

    if (!selectedAction) {
        alert('Please select an action first.');
        return;
    }

    if (selectedStudents.size === 0) {
        alert('Please select at least one student first.');
        return;
    }

    switch (selectedAction) {
        case 'add_tag':
            openBulkTagModal('add');
            break;
        case 'remove_tag':
            openBulkTagModal('remove');
            break;
        case 'send_notification':
            openBulkNotificationModal();
            break;
        default:
            alert('Unknown action selected.');
    }
}

function openBulkNotificationModal() {
    if (selectedStudents.size === 0) {
        alert('Please select at least one student first.');
        return;
    }
    
    // Update the modal with selected student IDs
    document.getElementById('selectedStudentIds').value = Array.from(selectedStudents).join(',');
    document.getElementById('recipientCount').textContent = selectedStudents.size;
    
    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('bulkNotificationModal'));
    modal.show();
}

// Handle notification type change
document.addEventListener('DOMContentLoaded', function() {
    const notificationTypeSelect = document.getElementById('notificationType');
    const emailSubjectGroup = document.getElementById('emailSubjectGroup');
    const messageContent = document.getElementById('messageContent');
    const messageCounter = document.getElementById('messageCounter');
    const smsWarning = document.getElementById('smsWarning');
    
    function updateFormVisibility() {
        const notificationType = notificationTypeSelect.value;
        
        // Show/hide email subject field
        if (notificationType === 'email' || notificationType === 'both') {
            emailSubjectGroup.style.display = 'block';
            document.getElementById('emailSubject').required = true;
        } else {
            emailSubjectGroup.style.display = 'none';
            document.getElementById('emailSubject').required = false;
        }
        
        // Show/hide SMS character warning
        if (notificationType === 'sms' || notificationType === 'both') {
            smsWarning.style.display = 'inline';
        } else {
            smsWarning.style.display = 'none';
        }
    }
    
    function updateCharacterCount() {
        const length = messageContent.value.length;
        messageCounter.textContent = length;
        
        if (length > 160 && (notificationTypeSelect.value === 'sms' || notificationTypeSelect.value === 'both')) {
            messageCounter.classList.add('text-danger');
        } else {
            messageCounter.classList.remove('text-danger');
        }
    }
    
    notificationTypeSelect.addEventListener('change', updateFormVisibility);
    messageContent.addEventListener('input', updateCharacterCount);
    
    // Initial setup
    updateFormVisibility();
    updateCharacterCount();
    
    // Handle form submission
    document.getElementById('bulkNotificationForm').addEventListener('submit', function(e) {
        const notificationType = notificationTypeSelect.value;
        const messageLength = messageContent.value.length;
        
        // Validate SMS length
        if ((notificationType === 'sms' || notificationType === 'both') && messageLength > 160) {
            e.preventDefault();
            alert('SMS messages cannot exceed 160 characters. Please shorten your message.');
            return false;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        submitBtn.disabled = true;
        
        // Re-enable after 10 seconds as fallback
        setTimeout(() => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }, 10000);
    });
});

// Auto-submit search form when tag filter changes
document.getElementById('tag_filter').addEventListener('change', function() {
    document.getElementById('searchForm').submit();
});
</script>
{% endblock %}