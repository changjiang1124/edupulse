{% extends 'base.html' %}
{% load static %}

{% block title %}Students - EduPulse{% endblock %}

{% block extra_css %}
<style>
    .tag-badge {
        font-size: 0.75rem;
        margin-right: 2px;
        margin-bottom: 2px;
    }
    .student-checkbox {
        cursor: pointer;
    }
    /* Z-Index层级体系标准化 */
    /* 层级体系：
       1-10: 基础内容层
       11-50: 交互元素层 (悬停、选中状态)
       51-100: 粘性/固定元素层
       1051-1070: 下拉框/模态框层 (遵循Bootstrap标准)
    */

    .card {
        position: relative;
        z-index: 1;
    }

    .card.card-filter {
        z-index: 30;
    }

    .card.card-student-list {
        z-index: 20;
    }

    .card-header, .card-body {
        position: relative;
        z-index: 2;
    }

    /* 表格悬停效果层级调整 */
    .table-hover tbody tr:hover {
        z-index: 15;
        position: relative;
    }

    /* 确保选中的行有合适的层级 */
    .clickable-row.selected {
        background-color: #e3f2fd !important;
        z-index: 16;
        position: relative;
    }

    /* 批量操作区域层级 */
    #bulkActionsCompact {
        border-left: 1px solid #dee2e6;
        padding-left: 1rem;
        white-space: nowrap;
        align-items: center;
        z-index: 10;
        position: relative;
    }

    #bulkActionsCompact .text-muted {
        margin-right: 0.5rem;
        flex-shrink: 0;
    }

    /* Multi-select dropdown styles */
    .multi-select-dropdown {
        position: relative;
        width: 100%;
        z-index: 1055;
    }

    /* 移除Bootstrap默认箭头，避免重复 */
    #tagFilterButton::after {
        display: none !important;
    }

    /* 确保容器不会干扰下拉框显示 */
    .card, .card-body, .table-responsive {
        overflow: visible !important;
    }

    .multi-select-dropdown .dropdown-menu {
        width: 100%;
        min-width: 100%;
        max-height: 348px;
        overflow: hidden;
        padding: 0;
        border: 1px solid #dee2e6;
        border-radius: 0.75rem;
        box-shadow: 0 1rem 2rem rgba(15, 23, 42, 0.18);
        background-color: #ffffff;
        position: absolute;
        left: 0;
        right: 0;
        z-index: 1100;
    }

    .multi-select-dropdown .dropdown-menu.show {
        transform: none !important;
    }

    .multi-select-dropdown .dropdown-menu[data-bs-popper] {
        margin-top: 0;
        top: calc(100% + 0.375rem);
        left: 0;
    }

    .dropdown-search {
        padding: 0.75rem;
        background: #ffffff;
        border-bottom: 1px solid #e2e8f0;
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .dropdown-search .form-control {
        border-radius: 0.5rem;
        border-color: #cbd5f5;
        box-shadow: none;
    }

    .dropdown-search .form-control:focus {
        border-color: #4361ee;
        box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.15);
    }

    .dropdown-options {
        max-height: 240px;
        overflow-y: auto;
        padding: 0.5rem 0;
    }

    .dropdown-item.tag-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.55rem 0.85rem;
        cursor: pointer;
        border: none;
        background: transparent;
        white-space: normal;
        width: 100%;
        text-align: left;
        border-left: 3px solid transparent;
        transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    .dropdown-item.tag-option:hover {
        background-color: #eef2ff;
        border-left-color: #4566ff;
    }

    .dropdown-item.tag-option .form-check-input {
        margin-top: 0;
    }

    .dropdown-item.tag-option .badge {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 999px;
    }

    .dropdown-item.tag-option small {
        margin-left: auto;
        color: #64748b;
        font-size: 0.75rem;
    }

    .dropdown-item.tag-option:active {
        background-color: #e9ecef;
    }

    .dropdown-footer {
        padding: 0.75rem;
        background-color: #f8fafc;
        border-top: 1px solid #e2e8f0;
        position: sticky;
        bottom: 0;
        z-index: 1;
    }

    .dropdown-footer .btn-link {
        color: #64748b;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
    }

    .dropdown-footer .btn-link:hover {
        color: #1d4ed8;
        text-decoration: underline;
    }

    .multi-select-dropdown .dropdown-toggle {
        text-align: left;
        cursor: pointer;
        border: 1px solid #ced4da;
        background-color: #fff;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 0.375rem;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    #tagFilterButton {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    #tagFilterLabel {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .multi-select-dropdown .dropdown-toggle:hover {
        border-color: #86b7fe;
    }

    .multi-select-dropdown .dropdown-toggle:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .multi-select-dropdown .dropdown-toggle .fas {
        font-size: 0.75rem;
        transition: transform 0.15s ease-in-out;
    }

    .multi-select-dropdown .dropdown-toggle[aria-expanded="true"] .fas {
        transform: rotate(180deg);
    }

    .dropdown-item.tag-option .form-check-input {
        margin-top: 0;
    }

    .dropdown-item.tag-option .badge {
        font-size: 0.75rem;
        font-weight: 500;
    }

    /* Search functionality */
    .dropdown-options .dropdown-item.hidden {
        display: none;
    }

    .dropdown-item.tag-option .badge {
        min-width: 60px;
        text-align: center;
    }

    /* Empty state */
    .dropdown-empty-state {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }

    /* Tag filter styles - keep for legacy compatibility */

    /* Compact bulk actions styles */
    .gap-3 {
        gap: 1rem !important;
    }

    .gap-2 {
        gap: 0.5rem !important;
    }

    /* Tag selection in modal */
    .tag-selection-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .tag-selection-item:hover {
        background-color: #f8f9fa;
    }

    .tag-selection-item.selected {
        background-color: #e3f2fd;
        border-color: #1976d2;
    }

    .tag-selection-item .tag-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tag-count {
        font-size: 0.875rem;
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-6">
        <h1 class="page-title">Student Management</h1>
        <p class="page-subtitle">Manage student profiles and information</p>
    </div>
    <div class="col-md-6 text-end">
        <a href="{% url 'students:student_add' %}" class="btn btn-primary">Add New Student</a>
    </div>
</div>

<!-- Search and Filters -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card card-filter">
            <div class="card-body">
                <form method="get" class="row g-3" id="searchForm">
                    <div class="col-md-3">
                        <label for="search" class="form-label">Search</label>
                        <input type="text" name="search" id="search" class="form-control"
                               placeholder="Search students by name, email, or guardian name..." value="{{ request.GET.search }}">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Filter by Tags</label>
                        <div class="position-relative">
                            <div class="multi-select-dropdown" id="tagFilterDropdown">
                                <button type="button" class="form-control dropdown-toggle d-flex justify-content-between align-items-center"
                                        data-bs-toggle="dropdown" aria-expanded="false" id="tagFilterButton">
                                    <span id="tagFilterLabel">Select tags...</span>
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="dropdown-menu" style="width: 100%;" id="tagFilterMenu">
                                    <div class="dropdown-search">
                                        <input type="text" class="form-control form-control-sm"
                                               placeholder="Search tags..." id="tagSearchInput">
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-options" id="tagDropdownOptions">
                                        {% for tag in student_tags %}
                                        <label class="dropdown-item tag-option" data-tag-id="{{ tag.id }}" data-tag-name="{{ tag.name }}">
                                            <input type="checkbox" name="tags" value="{{ tag.id }}"
                                                   class="form-check-input me-2 tag-filter-checkbox"
                                                   {% if tag.id in selected_tag_ids %}checked{% endif %}>
                                            <span class="badge me-2" style="background-color: {{ tag.colour }};">
                                                {{ tag.name }}
                                            </span>
                                            <small class="text-muted ms-auto">({{ tag.students.count }} students)</small>
                                        </label>
                                        {% endfor %}
                                    </div>
                                    <div class="dropdown-divider"></div>
                                    <div class="dropdown-footer d-flex justify-content-between align-items-center">
                                        <button type="button" class="btn btn-link btn-sm p-0" onclick="clearAllTagFilters()">
                                            <i class="fas fa-times"></i> Clear All
                                        </button>
                                        <small class="text-muted">
                                            <span id="selectedTagCount">{{ selected_tag_ids|length }}</span> tag{{ selected_tag_ids|length|pluralize }} selected
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="level" class="form-label">Filter by Level</label>
                        <select name="level" id="level" class="form-select">
                            <option value="">All levels</option>
                            <option value="none" {% if selected_level == 'none' %}selected{% endif %}>No level assigned</option>
                            {% for student_level in student_levels %}
                                <option value="{{ student_level.id }}" {% if selected_level == student_level.id|stringformat:'s' %}selected{% endif %}>
                                    {{ student_level.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-outline-primary w-100">Search</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Students List -->
<div class="row">
    <div class="col-12">
        <div class="card card-student-list">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Students ({{ students|length }})</h5>
                <div class="d-flex align-items-center gap-3">
                    <!-- Compact Bulk Actions (initially hidden) -->
                    <div id="bulkActionsCompact" class="d-flex align-items-center gap-2" style="display: none;">
                        <span class="text-muted small">
                            <span id="selectedCountCompact">0</span> selected
                        </span>
                        <select id="bulkActionSelect" class="form-select form-select-sm" style="min-width: 180px;">
                            <option value="">Choose action...</option>
                            <option value="add_tag">Add Tag</option>
                            <option value="remove_tag">Remove Tag</option>
                            {% if request.user.role == 'admin' %}
                            <option value="send_notification">Send Notification</option>
                            {% endif %}
                        </select>
                        <button type="button" id="bulkApplyBtn" class="btn btn-sm btn-primary" onclick="handleBulkAction()">
                            Apply
                        </button>
                    </div>
                    <!-- Select All Area -->
                    <div>
                        <input type="checkbox" class="form-check-input" id="selectAllCheckbox" onchange="toggleAllStudents()">
                        <label class="form-check-label ms-2" for="selectAllCheckbox">Select All</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if students %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="40px">
                                        <i class="fas fa-check-square text-muted"></i>
                                    </th>
                                    <th>Name</th>
                                    <th>Contact</th>
                                    <th>Tags</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for student in students %}
                                <tr id="student-row-{{ student.pk }}">
                                    <td>
                                        <input type="checkbox" class="form-check-input student-checkbox"
                                               value="{{ student.pk }}" onchange="toggleStudentSelection({{ student.pk }}, this.checked)"
                                               onclick="event.stopPropagation()">
                                    </td>
                                    <td>
                                        <strong>{{ student.first_name }} {{ student.last_name }}</strong>
                                        {% if student.birth_date %}
                                            <br><small class="text-muted">Born: {{ student.birth_date|date:"d/m/Y" }}</small>
                                        {% endif %}
                                        {% if student.level %}
                                            <br><span class="badge bg-info text-white">
                                                <i class="fas fa-layer-group me-1"></i>{{ student.level.name }}
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if student.contact_email %}
                                            <div><i class="fas fa-envelope text-muted"></i> {{ student.contact_email }}</div>
                                        {% endif %}
                                        {% if student.contact_phone %}
                                            <div><i class="fas fa-phone text-muted"></i> {{ student.contact_phone }}</div>
                                        {% endif %}
                                        {% if not student.contact_email and not student.contact_phone %}
                                            <span class="text-muted">No contact info</span>
                                        {% endif %}
                                        {% if student.guardian_name %}
                                            <small class="text-muted"><i class="fas fa-user-friends"></i> Guardian contact</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% for tag in student.tags.all %}
                                            <span class="badge tag-badge" style="background-color: {{ tag.colour }};">
                                                {{ tag.name }}
                                            </span>
                                        {% empty %}
                                            <span class="text-muted">No tags</span>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <span class="status-badge {% if student.is_active %}status-active{% else %}status-inactive{% endif %}">
                                            {% if student.is_active %}Active{% else %}Inactive{% endif %}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'students:student_detail' student.pk %}" 
                                               class="btn btn-outline-primary btn-sm">View</a>
                                            <a href="{% url 'students:student_edit' student.pk %}" 
                                               class="btn btn-outline-secondary btn-sm">Edit</a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    {% if is_paginated %}
                    <nav aria-label="Student pagination">
                        <ul class="pagination justify-content-center">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ page_obj.previous_page_number }}">Previous</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item active">
                                <span class="page-link">
                                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                                </span>
                            </li>
                            
                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?{% if request.GET.search %}search={{ request.GET.search }}&{% endif %}page={{ page_obj.next_page_number }}">Next</a>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-4">
                        <p class="text-muted mb-3">No students found.</p>
                        <a href="{% url 'students:student_add' %}" class="btn btn-primary">Add First Student</a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Bulk Notification Modal -->
<div class="modal fade" id="bulkNotificationModal" tabindex="-1" aria-labelledby="bulkNotificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkNotificationModalLabel">Send Bulk Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'students:bulk_notification_start' %}" id="bulkNotificationForm">
                <div class="modal-body">
                    {% csrf_token %}
                    <input type="hidden" name="student_ids" id="selectedStudentIds">
                    <input type="hidden" name="send_to" value="selected">

                    <!-- Progress Display Area (initially hidden) -->
                    <div id="progressArea" style="display: none;">
                        <div class="alert alert-info">
                            <i class="fas fa-paper-plane"></i>
                            <strong>Sending notifications...</strong>
                        </div>
                        <div class="progress mb-3">
                            <div class="progress-bar progress-bar-striped progress-bar-animated"
                                 id="progressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-center">
                            <small id="progressText">Preparing to send notifications...</small>
                        </div>
                        <div id="progressStats" class="mt-2" style="display: none;">
                            <div class="row text-center">
                                <div class="col-4">
                                    <small class="text-success">Sent: <span id="progressSent">0</span></small>
                                </div>
                                <div class="col-4">
                                    <small class="text-danger">Failed: <span id="progressFailed">0</span></small>
                                </div>
                                <div class="col-4">
                                    <small class="text-info">Total: <span id="progressTotal">0</span></small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Fields Area -->
                    <div id="formFieldsArea">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>Recipients:</strong> <span id="recipientCount">0</span> students selected
                        </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="notificationType" class="form-label">Notification Type</label>
                                <select class="form-select" id="notificationType" name="notification_type" 
                                        onchange="handleNotificationTypeChange(this.value)" required>
                                    <option value="email" selected>Email Only</option>
                                    <option value="sms">SMS Only</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Message Type hidden field with default value -->
                    <input type="hidden" id="messageType" name="message_type" value="general">
                    
                    <!-- Email Fields -->
                    <div id="emailFieldsGroup">
                        <div class="mb-3">
                            <label for="emailSubject" class="form-label">Email Subject</label>
                            <input type="text" class="form-control" id="emailSubject" name="subject" 
                                   placeholder="Enter email subject">
                        </div>
                        
                        <div class="mb-3">
                            <label for="emailContent" class="form-label">Email Content</label>
                            <textarea class="form-control tinymce-editor" id="emailContent" name="email_content" 
                                      rows="15"></textarea>
                            <div class="form-text">Rich HTML content for email with images and formatting</div>
                        </div>
                    </div>
                    
                    <!-- SMS Fields -->
                    <div id="smsFieldsGroup" style="display: none;">
                        <div class="mb-3">
                            <label for="smsContent" class="form-label">SMS Message</label>
                            <textarea class="form-control" id="smsContent" name="sms_content" rows="4" 
                                      maxlength="160" placeholder="Enter SMS message (max 160 characters)"></textarea>
                            <div class="form-text">
                                <span id="smsCounter">0</span>/160 characters
                            </div>
                        </div>
                    </div>

                </div> <!-- End of formFieldsArea -->
                <div class="modal-footer" id="modalFooter">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="sendBtn">
                        <i class="fas fa-paper-plane"></i> Send Notification
                    </button>
                    <button type="button" class="btn btn-success" style="display: none;" id="doneBtn" data-bs-dismiss="modal">
                        <i class="fas fa-check"></i> Done
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Bulk Tag Operation Modal -->
<div class="modal fade" id="bulkTagModal" tabindex="-1" aria-labelledby="bulkTagModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkTagModalLabel">Bulk Tag Operation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <strong>Operation:</strong> <span id="tagOperationMode">Add</span> tags for <span id="tagRecipientCount">0</span> selected students
                </div>

                <!-- Add Tags Interface -->
                <div id="addTagsInterface" style="display: none;">
                    <div class="mb-3">
                        <label for="tagNameInput" class="form-label">Enter Tag Names:</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="tagNameInput"
                                   placeholder="Type tag names separated by commas (e.g. VIP, New Student, Regular)"
                                   autocomplete="off">
                            <div id="tagSuggestions" class="position-absolute bg-white border rounded shadow-sm w-100"
                                 style="top: 100%; z-index: 1050; display: none; max-height: 200px; overflow-y: auto;">
                                <!-- Suggestions will be loaded here -->
                            </div>
                        </div>
                        <div class="form-text">
                            New tags will be created automatically. Tag names are case-insensitive.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags to Add:</label>
                        <div id="selectedTagsDisplay" class="border rounded p-2 bg-light" style="min-height: 50px;">
                            <span class="text-muted">No tags selected</span>
                        </div>
                    </div>
                </div>

                <!-- Remove Tags Interface -->
                <div id="removeTagsInterface" style="display: none;">
                    <div class="mb-3">
                        <label for="tagRemoveSearchInput" class="form-label">Search Existing Tags:</label>
                        <div class="position-relative">
                            <input type="text" class="form-control" id="tagRemoveSearchInput"
                                   placeholder="Search for tags to remove..."
                                   autocomplete="off">
                            <div id="tagSearchResults" class="position-absolute bg-white border rounded shadow-sm w-100"
                                 style="top: 100%; z-index: 1050; display: none; max-height: 200px; overflow-y: auto;">
                                <!-- Search results will be loaded here -->
                            </div>
                        </div>
                        <div class="form-text">
                            Only existing tags can be removed from students.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Tags to Remove:</label>
                        <div id="selectedRemoveTagsDisplay" class="border rounded p-2 bg-light" style="min-height: 50px;">
                            <span class="text-muted">No tags selected</span>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">
                        <span id="selectedTagsCount">0</span> tag(s) selected for operation
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="performTagOperation" onclick="performBulkTagOperation()">
                    <i class="fas fa-tag"></i> <span id="tagOperationButtonText">Add Tags</span>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- TinyMCE Library -->
<script src="{% static 'tinymce/tinymce.min.js' %}"></script>

<script>
let selectedStudents = new Set();
let availableTags = [];
let selectedTagsForOperation = new Set();
let currentTagOperation = 'add';

// Multi-select dropdown tag filter functions
class TagFilterDropdown {
    constructor() {
        this.selectedTags = new Set();
        this.allTags = [];
        this.searchInput = null;
        this.dropdownOptions = null;
        this.init();
    }

    init() {
        this.loadTags();
        this.bindEvents();
        this.updateDisplay();
    }

    loadTags() {
        // Load tags from DOM
        const tagOptions = document.querySelectorAll('.tag-option');
        this.allTags = Array.from(tagOptions).map(option => ({
            id: parseInt(option.dataset.tagId),
            name: option.dataset.tagName,
            element: option,
            checkbox: option.querySelector('input[type="checkbox"]')
        }));

        // Load selected tags from checkboxes
        this.allTags.forEach(tag => {
            if (tag.checkbox.checked) {
                this.selectedTags.add(tag.id);
            }
        });
    }

    bindEvents() {
        // Search input
        this.searchInput = document.getElementById('tagSearchInput');
        if (this.searchInput) {
            this.searchInput.addEventListener('input', (e) => this.filterTags(e.target.value));
        }

        // Tag checkboxes
        this.allTags.forEach(tag => {
            tag.checkbox.addEventListener('change', (e) => {
                e.stopPropagation();
                this.toggleTag(tag.id, e.target.checked);
            });
        });

        // Dropdown menu click handling
        this.dropdownOptions = document.getElementById('tagDropdownOptions');
        if (this.dropdownOptions) {
            this.dropdownOptions.addEventListener('click', (e) => {
                // Prevent dropdown from closing when clicking inside
                e.stopPropagation();
            });
        }

        // Prevent dropdown from closing when clicking search input
        if (this.searchInput) {
            this.searchInput.addEventListener('click', (e) => e.stopPropagation());
        }
    }

    toggleTag(tagId, checked) {
        if (checked) {
            this.selectedTags.add(tagId);
        } else {
            this.selectedTags.delete(tagId);
        }
        this.updateDisplay();
        this.submitFilter();
    }

    filterTags(searchTerm) {
        const term = searchTerm.toLowerCase().trim();
        let visibleCount = 0;

        this.allTags.forEach(tag => {
            const matches = tag.name.toLowerCase().includes(term);
            tag.element.classList.toggle('hidden', !matches);
            if (matches) visibleCount++;
        });

        // Show/hide empty state
        this.updateEmptyState(visibleCount === 0 && term.length > 0);
    }

    updateEmptyState(show) {
        let emptyState = document.getElementById('tagDropdownEmptyState');

        if (show && !emptyState) {
            // Create empty state element
            emptyState = document.createElement('div');
            emptyState.id = 'tagDropdownEmptyState';
            emptyState.className = 'dropdown-empty-state';
            emptyState.textContent = 'No tags found matching your search';
            this.dropdownOptions.appendChild(emptyState);
        } else if (!show && emptyState) {
            // Remove empty state element
            emptyState.remove();
        }
    }

    updateDisplay() {
        // Update button label
        const button = document.getElementById('tagFilterLabel');
        const count = this.selectedTags.size;

        if (count === 0) {
            button.textContent = 'Select tags...';
        } else if (count === 1) {
            const selectedTag = this.allTags.find(tag => this.selectedTags.has(tag.id));
            button.textContent = selectedTag ? selectedTag.name : '1 tag selected';
        } else {
            button.textContent = `${count} tags selected`;
        }

        // Update count in footer
        const countSpan = document.getElementById('selectedTagCount');
        if (countSpan) {
            countSpan.textContent = count;
        }
    }

    clearAll() {
        this.selectedTags.clear();
        this.allTags.forEach(tag => {
            tag.checkbox.checked = false;
        });
        this.updateDisplay();
        this.submitFilter();
    }

    submitFilter() {
        // Auto-submit form when selection changes
        setTimeout(() => {
            document.getElementById('searchForm').submit();
        }, 100);
    }
}

// Initialize tag filter dropdown
let tagFilterDropdown;

// Tag filtering functions (legacy compatibility)
function updateTagFilter() {
    if (tagFilterDropdown) {
        tagFilterDropdown.updateDisplay();
        tagFilterDropdown.submitFilter();
    }
}

function updateSelectedTagCount() {
    if (tagFilterDropdown) {
        tagFilterDropdown.updateDisplay();
    }
}

function clearAllTagFilters() {
    if (tagFilterDropdown) {
        tagFilterDropdown.clearAll();
    }
}

// Student selection functions
function toggleStudentSelection(studentId, checked) {
    const row = document.getElementById(`student-row-${studentId}`);

    if (checked) {
        selectedStudents.add(studentId);
        if (row) row.classList.add('selected');
    } else {
        selectedStudents.delete(studentId);
        if (row) row.classList.remove('selected');
    }

    updateBulkActionsVisibility();
    updateSelectAllCheckbox();
}

function toggleAllStudents() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');

    studentCheckboxes.forEach(checkbox => {
        const studentId = parseInt(checkbox.value);
        const row = document.getElementById(`student-row-${studentId}`);

        checkbox.checked = selectAllCheckbox.checked;

        if (selectAllCheckbox.checked) {
            selectedStudents.add(studentId);
            if (row) row.classList.add('selected');
        } else {
            selectedStudents.delete(studentId);
            if (row) row.classList.remove('selected');
        }
    });

    updateBulkActionsVisibility();
}

function updateBulkActionsVisibility() {
    const compactActions = document.getElementById('bulkActionsCompact');
    const countSpan = document.getElementById('selectedCountCompact');

    countSpan.textContent = selectedStudents.size;

    if (selectedStudents.size > 0) {
        compactActions.style.display = 'flex';
    } else {
        compactActions.style.display = 'none';
        // Reset the action selection when no students selected
        document.getElementById('bulkActionSelect').value = '';
    }
}

function updateSelectAllCheckbox() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const visibleCheckboxes = document.querySelectorAll('.student-checkbox');
    const checkedBoxes = document.querySelectorAll('.student-checkbox:checked');

    if (checkedBoxes.length === 0) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = false;
    } else if (checkedBoxes.length === visibleCheckboxes.length) {
        selectAllCheckbox.indeterminate = false;
        selectAllCheckbox.checked = true;
    } else {
        selectAllCheckbox.indeterminate = true;
        selectAllCheckbox.checked = false;
    }
}

function handleBulkAction() {
    const selectedAction = document.getElementById('bulkActionSelect').value;

    if (!selectedAction) {
        alert('Please select an action first.');
        return;
    }

    if (selectedStudents.size === 0) {
        alert('Please select at least one student first.');
        return;
    }

    switch (selectedAction) {
        case 'add_tag':
            openBulkTagModal('add');
            break;
        case 'remove_tag':
            openBulkTagModal('remove');
            break;
        case 'send_notification':
            openBulkNotificationModal();
            break;
        default:
            alert('Unknown action selected.');
    }
}

function openBulkNotificationModal() {
    if (selectedStudents.size === 0) {
        alert('Please select at least one student first.');
        return;
    }

    // Update the modal with selected student IDs
    document.getElementById('selectedStudentIds').value = Array.from(selectedStudents).join(',');
    document.getElementById('recipientCount').textContent = selectedStudents.size;

    // Show the modal
    const modal = new bootstrap.Modal(document.getElementById('bulkNotificationModal'));
    modal.show();
}

// Bulk tag operation functions
// selectedTagsForOperation already declared above, just clear it and add data storage
let selectedTagsData = new Map(); // Store tag data (id, name, colour, exists)

async function openBulkTagModal(operation) {
    if (selectedStudents.size === 0) {
        alert('Please select at least one student first.');
        return;
    }

    currentTagOperation = operation;
    selectedTagsForOperation.clear();
    selectedTagsData.clear();

    // Update modal UI
    document.getElementById('tagOperationMode').textContent = operation === 'add' ? 'Add' : 'Remove';
    document.getElementById('tagRecipientCount').textContent = selectedStudents.size;
    document.getElementById('tagOperationButtonText').textContent = operation === 'add' ? 'Add Tags' : 'Remove Tags';

    const performButton = document.getElementById('performTagOperation');
    performButton.className = operation === 'add' ? 'btn btn-success' : 'btn btn-warning';

    // Show/hide appropriate interface
    const addInterface = document.getElementById('addTagsInterface');
    const removeInterface = document.getElementById('removeTagsInterface');

    if (operation === 'add') {
        addInterface.style.display = 'block';
        removeInterface.style.display = 'none';
        resetAddTagsInterface();
    } else {
        addInterface.style.display = 'none';
        removeInterface.style.display = 'block';
        resetRemoveTagsInterface();
    }

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('bulkTagModal'));
    modal.show();
}

async function loadAvailableTags() {
    try {
        const response = await fetch('{% url "students:get_available_tags" %}', {
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        const data = await response.json();

        if (data.success) {
            availableTags = data.tags;
            renderTagSelection();
        } else {
            throw new Error(data.error || 'Failed to load tags');
        }
    } catch (error) {
        console.error('Error loading tags:', error);
        document.getElementById('tagSelectionContainer').innerHTML =
            '<div class="text-danger">Error loading tags. Please try again.</div>';
    }
}

function renderTagSelection() {
    const container = document.getElementById('tagSelectionContainer');
    selectedTagsForOperation.clear();

    if (availableTags.length === 0) {
        container.innerHTML = '<div class="text-muted">No tags available.</div>';
        return;
    }

    let html = '';
    availableTags.forEach(tag => {
        html += `
            <div class="tag-selection-item" onclick="toggleTagForOperation(${tag.id})" id="tag-item-${tag.id}">
                <div class="tag-info">
                    <div>
                        <span class="badge" style="background-color: ${tag.colour};">
                            ${tag.name}
                        </span>
                    </div>
                    <div class="tag-count">
                        ${tag.student_count} students
                    </div>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
    updateSelectedTagsCount();
}

function toggleTagForOperation(tagId) {
    const tagItem = document.getElementById(`tag-item-${tagId}`);

    if (selectedTagsForOperation.has(tagId)) {
        selectedTagsForOperation.delete(tagId);
        tagItem.classList.remove('selected');
    } else {
        selectedTagsForOperation.add(tagId);
        tagItem.classList.add('selected');
    }

    updateSelectedTagsCount();
}

function updateSelectedTagsCount() {
    document.getElementById('selectedTagsCount').textContent = selectedTagsForOperation.size;
}

async function performBulkTagOperation() {
    if (selectedTagsForOperation.size === 0) {
        alert('Please select at least one tag for the operation.');
        return;
    }

    const performButton = document.getElementById('performTagOperation');
    const originalText = performButton.innerHTML;
    performButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    performButton.disabled = true;

    try {
        const formData = new FormData();
        formData.append('student_ids', Array.from(selectedStudents).join(','));
        formData.append('operation', currentTagOperation);

        // Use tag names instead of IDs for the new dynamic system
        const tagNames = Array.from(selectedTagsForOperation);
        formData.append('tag_names', tagNames.join(','));

        const response = await fetch('{% url "students:bulk_tag_operation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(`Success! ${data.message}`);

            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('bulkTagModal')).hide();

            // Refresh the page to show updated tags
            window.location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Error performing bulk tag operation:', error);
        alert('An error occurred while performing the operation. Please try again.');
    } finally {
        performButton.innerHTML = originalText;
        performButton.disabled = false;
    }
}

// Remove duplicate functions - already defined above
// Remove duplicate functions - already defined above

// Handle notification type change
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tag filter dropdown
    tagFilterDropdown = new TagFilterDropdown();

    const bulkNotificationForm = document.getElementById('bulkNotificationForm');
    if (!bulkNotificationForm) {
        return;
    }

    const notificationTypeSelect = document.getElementById('notificationType');
    const emailFieldsGroup = document.getElementById('emailFieldsGroup'); // Updated ID
    const smsContent = document.getElementById('smsContent'); // New ID
    const smsWarning = document.getElementById('smsWarning'); // Optional warning element

    // Check if elements exist before proceeding
    if (notificationTypeSelect && emailFieldsGroup && smsContent) {

        function updateFormVisibility() {
            const notificationType = notificationTypeSelect.value;

            // Show/hide email subject field
            if (notificationType === 'email' || notificationType === 'both') {
                emailFieldsGroup.style.display = 'block';
                document.getElementById('emailSubject').required = true;
                // TinyMCE might need to be initialized/re-initialized here if it's dynamically shown
            } else {
                emailFieldsGroup.style.display = 'none';
                document.getElementById('emailSubject').required = false;
            }

            // Show/hide SMS character warning
            if (notificationType === 'sms' || notificationType === 'both') {
                smsContent.style.display = 'block'; // Assuming smsContent is a textarea or similar
                if (smsWarning) smsWarning.style.display = 'inline';
            } else {
                smsContent.style.display = 'none';
                if (smsWarning) smsWarning.style.display = 'none';
            }
        }

        notificationTypeSelect.addEventListener('change', updateFormVisibility);

        // Initial setup
        updateFormVisibility();

        // Handle form submission with progress tracking
        bulkNotificationForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const notificationType = notificationTypeSelect.value;

            // Validate based on type
            if (notificationType === 'email') {
                const subject = document.getElementById('emailSubject').value;
                const content = tinymce.get('emailContent') ? tinymce.get('emailContent').getContent() : '';

                if (!subject.trim()) {
                    alert('Please enter an email subject.');
                    return false;
                }
                if (!content.trim()) {
                    alert('Please enter email content.');
                    return false;
                }
                // Sync TinyMCE content to textarea
                tinymce.triggerSave();
            } else if (notificationType === 'sms') {
                const content = document.getElementById('smsContent').value;
                if (!content.trim()) {
                    alert('Please enter SMS message.');
                    return false;
                }
                if (content.length > 160) {
                    alert('SMS messages cannot exceed 160 characters. Please shorten your message.');
                    return false;
                }
            }

            // Start progress display
            showProgressArea();

            try {
                // Step 1: Start the bulk notification task
                const taskId = await startBulkNotification();

                // Step 2: Execute the task and monitor progress
                await executeBulkNotificationWithProgress(taskId);

            } catch (error) {
                console.error('Bulk notification error:', error);
                hideProgressArea();
                alert('An error occurred while sending notifications. Please try again.');
            }
        });
    }

    // Tag search input event listener (RENAMED ID)
    const tagRemoveSearchInput = document.getElementById('tagRemoveSearchInput'); // Renamed
    if (tagRemoveSearchInput) {
        tagRemoveSearchInput.addEventListener('input', handleTagSearch);

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            const results = document.getElementById('tagSearchResults');
            if (results && !tagRemoveSearchInput.contains(event.target) && !results.contains(event.target)) {
                hideSearchResults();
            }
        });
    }
});

// Reset interfaces
function resetAddTagsInterface() {
    document.getElementById('tagNameInput').value = '';
    document.getElementById('selectedTagsDisplay').innerHTML = '<span class="text-muted">No tags selected</span>';
    hideSuggestions();
    updateSelectedTagsCount();
}

function resetRemoveTagsInterface() {
    const input = document.getElementById('tagRemoveSearchInput'); // Renamed ID
    if (input) input.value = '';
    document.getElementById('selectedRemoveTagsDisplay').innerHTML = '<span class="text-muted">No tags selected</span>';
    hideSearchResults();
    updateSelectedTagsCount();
}

// Tag suggestions for add interface
let suggestionTimeout;
async function handleTagInput(event) {
    const input = event.target;
    const query = input.value.trim();

    // Clear previous timeout
    if (suggestionTimeout) {
        clearTimeout(suggestionTimeout);
    }

    if (query.length < 1) {
        hideSuggestions();
        return;
    }

    // Debounce API calls
    suggestionTimeout = setTimeout(async () => {
        await fetchTagSuggestions(query);
    }, 300);
}

async function fetchTagSuggestions(query) {
    try {
        const response = await fetch(`{% url "students:suggest_tag_name" %}?q=${encodeURIComponent(query)}&limit=5`);
        const data = await response.json();

        if (data.success) {
            displayTagSuggestions(data.suggestions);
        }
    } catch (error) {
        console.error('Error fetching tag suggestions:', error);
    }
}

function displayTagSuggestions(suggestions) {
    const container = document.getElementById('tagSuggestions');

    if (suggestions.length === 0) {
        hideSuggestions();
        return;
    }

    let html = '';
    suggestions.forEach(suggestion => {
        const existsText = suggestion.exists ?
            `<small class="text-success ms-2">(${suggestion.student_count} students)</small>` :
            '<small class="text-primary ms-2">(new tag)</small>';

        html += `
            <div class="dropdown-item" style="cursor: pointer;" onclick="selectTagSuggestion('${suggestion.name}', ${suggestion.exists}, '${suggestion.colour}')">
                <span class="badge" style="background-color: ${suggestion.colour};">${suggestion.name}</span>
                ${existsText}
            </div>
        `;
    });

    container.innerHTML = html;
    container.style.display = 'block';
}

function selectTagSuggestion(name, exists, colour) {
    const input = document.getElementById('tagNameInput');
    const currentValue = input.value.trim();
    const parts = currentValue.split(',');

    // Replace the last part (current typing) with selected suggestion
    parts[parts.length - 1] = name;
    input.value = parts.join(', ') + ', ';

    // Add to selected tags
    addTagToSelection(name, exists, colour);

    hideSuggestions();
    input.focus();
}

function addTagToSelection(name, exists, colour) {
    const normalizedName = name.toLowerCase().trim();

    if (selectedTagsData.has(normalizedName)) {
        return; // Already selected
    }

    selectedTagsData.set(normalizedName, {
        name: normalizedName,
        exists: exists,
        colour: colour
    });

    selectedTagsForOperation.add(normalizedName);
    updateSelectedTagsDisplay();
}

function updateSelectedTagsDisplay() {
    const container = document.getElementById('selectedTagsDisplay');

    if (selectedTagsData.size === 0) {
        container.innerHTML = '<span class="text-muted">No tags selected</span>';
        updateSelectedTagsCount();
        return;
    }

    let html = '';
    selectedTagsData.forEach((tagData, key) => {
        const existsText = tagData.exists ? '' : ' (new)';
        html += `
            <span class="badge me-2 mb-2" style="background-color: ${tagData.colour};">
                ${tagData.name}${existsText}
                <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;"
                        onclick="removeTagFromSelection('${key}')" title="Remove tag"></button>
            </span>
        `;
    });

    container.innerHTML = html;
    updateSelectedTagsCount();
}

function removeTagFromSelection(key) {
    selectedTagsData.delete(key);
    selectedTagsForOperation.delete(key);
    updateSelectedTagsDisplay();
}

function hideSuggestions() {
    document.getElementById('tagSuggestions').style.display = 'none';
}

// Tag search for remove interface
let searchTimeout;
async function handleTagSearch(event) {
    const input = event.target;
    const query = input.value.trim();

    // Clear previous timeout
    if (searchTimeout) {
        clearTimeout(searchTimeout);
    }

    if (query.length < 2) {
        hideSearchResults();
        return;
    }

    // Debounce API calls
    searchTimeout = setTimeout(async () => {
        await searchExistingTags(query);
    }, 300);
}

async function searchExistingTags(query) {
    try {
        const response = await fetch(`{% url "students:search_tags" %}?q=${encodeURIComponent(query)}&limit=10`);
        const data = await response.json();

        if (data.success) {
            displayTagSearchResults(data.tags);
        }
    } catch (error) {
        console.error('Error searching tags:', error);
    }
}

function displayTagSearchResults(tags) {
    const container = document.getElementById('tagSearchResults');

    if (tags.length === 0) {
        container.innerHTML = '<div class="dropdown-item text-muted">No matching tags found</div>';
        container.style.display = 'block';
        return;
    }

    let html = '';
    tags.forEach(tag => {
        const isSelected = selectedTagsData.has(tag.name);
        const disabledClass = isSelected ? 'text-muted' : '';
        const clickHandler = isSelected ? '' : `onclick="selectTagForRemoval('${tag.name}', '${tag.colour}', ${tag.id})"`;

        html += `
            <div class="dropdown-item ${disabledClass}" style="cursor: ${isSelected ? 'default' : 'pointer'};" ${clickHandler}>
                <span class="badge" style="background-color: ${tag.colour};">${tag.name}</span>
                <small class="text-muted ms-2">(${tag.student_count} students)</small>
                ${isSelected ? '<small class="text-success ms-2">✓ Selected</small>' : ''}
            </div>
        `;
    });

    container.innerHTML = html;
    container.style.display = 'block';
}

function selectTagForRemoval(name, colour, id) {
    if (selectedTagsData.has(name)) {
        return; // Already selected
    }

    selectedTagsData.set(name, {
        name: name,
        exists: true,
        colour: colour,
        id: id
    });

    selectedTagsForOperation.add(name);
    updateSelectedRemoveTagsDisplay();

    // Refresh search results to show selected state
    const query = document.getElementById('tagRemoveSearchInput').value.trim();
    if (query.length >= 2) {
        searchExistingTags(query);
    }
}

function updateSelectedRemoveTagsDisplay() {
    const container = document.getElementById('selectedRemoveTagsDisplay');

    if (selectedTagsData.size === 0) {
        container.innerHTML = '<span class="text-muted">No tags selected</span>';
        updateSelectedTagsCount();
        return;
    }

    let html = '';
    selectedTagsData.forEach((tagData, key) => {
        html += `
            <span class="badge me-2 mb-2" style="background-color: ${tagData.colour};">
                ${tagData.name}
                <button type="button" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;"
                        onclick="removeTagFromRemovalSelection('${key}')" title="Remove tag"></button>
            </span>
        `;
    });

    container.innerHTML = html;
    updateSelectedTagsCount();
}

function removeTagFromRemovalSelection(key) {
    selectedTagsData.delete(key);
    selectedTagsForOperation.delete(key);
    updateSelectedRemoveTagsDisplay();

    // Refresh search results to show updated state
    const query = document.getElementById('tagRemoveSearchInput').value.trim();
    if (query.length >= 2) {
        searchExistingTags(query);
    }
}

function hideSearchResults() {
    document.getElementById('tagSearchResults').style.display = 'none';
}

function updateSelectedTagsCount() {
    document.getElementById('selectedTagsCount').textContent = selectedTagsForOperation.size;
}

function processTagInput() {
    const input = document.getElementById('tagNameInput');
    const value = input.value.trim();

    if (!value) return;

    // Split by comma and process each tag
    const parts = value.split(',');
    const lastPart = parts[parts.length - 1].trim();

    if (lastPart) {
        // Add the current tag
        const normalizedName = lastPart.toLowerCase();
        addTagToSelection(normalizedName, false, generateRandomColor());

        // Clear input
        input.value = '';
        hideSuggestions();
    }
}

function generateRandomColor() {
    const colors = [
        '#007bff', '#28a745', '#dc3545', '#ffc107', '#17a2b8',
        '#6f42c1', '#e83e8c', '#fd7e14', '#20c997', '#6c757d',
        '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ffeaa7',
        '#dda0dd', '#98d8c8', '#f7dc6f', '#bb8fce', '#85c1e9'
    ];
    return colors[Math.floor(Math.random() * colors.length)];
}

async function performBulkTagOperation() {
    if (selectedTagsForOperation.size === 0) {
        alert('Please select at least one tag for the operation.');
        return;
    }

    const performButton = document.getElementById('performTagOperation');
    const originalText = performButton.innerHTML;
    performButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
    performButton.disabled = true;

    try {
        const formData = new FormData();
        formData.append('student_ids', Array.from(selectedStudents).join(','));
        formData.append('operation', currentTagOperation);

        // Use tag names instead of IDs for the new dynamic system
        const tagNames = Array.from(selectedTagsForOperation);
        formData.append('tag_names', tagNames.join(','));

        const response = await fetch('{% url "students:bulk_tag_operation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            alert(`Success! ${data.message}`);

            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('bulkTagModal')).hide();

            // Refresh the page to show updated tags
            window.location.reload();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Error performing bulk tag operation:', error);
        alert('An error occurred while performing the operation. Please try again.');
    } finally {
        performButton.innerHTML = originalText;
        performButton.disabled = false;
    }
}

// Enhanced event listeners for tag input system
document.addEventListener('DOMContentLoaded', function() {
    // Add tags input event listener
    const tagNameInput = document.getElementById('tagNameInput');
    if (tagNameInput) {
        tagNameInput.addEventListener('input', handleTagInput);

        // Handle manual tag entry on Enter or comma
        tagNameInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' || event.key === ',') {
                event.preventDefault();
                processTagInput();
            }
        });

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!tagNameInput.contains(event.target) && !document.getElementById('tagSuggestions').contains(event.target)) {
                hideSuggestions();
            }
        });
    }

    // Tag search input event listener
    const tagSearchInput = document.getElementById('tagSearchInput');
    if (tagSearchInput) {
        tagSearchInput.addEventListener('input', handleTagSearch);

        // Hide search results when clicking outside
        document.addEventListener('click', function(event) {
            if (!tagSearchInput.contains(event.target) && !document.getElementById('tagSearchResults').contains(event.target)) {
                hideSearchResults();
            }
        });
    }
});

// Auto-submit search form when tag filter changes
// Legacy tag filter select (guarded to avoid null reference if element is absent)
const legacyTagFilter = document.getElementById('tag_filter');
if (legacyTagFilter) {
    legacyTagFilter.addEventListener('change', function() {
        document.getElementById('searchForm').submit();
    });
}

// Bulk Notification Progress Functions
function showProgressArea() {
    document.getElementById('formFieldsArea').style.display = 'none';
    document.getElementById('progressArea').style.display = 'block';
    document.getElementById('sendBtn').style.display = 'none';
    document.getElementById('cancelBtn').style.display = 'none';
}

function hideProgressArea() {
    document.getElementById('formFieldsArea').style.display = 'block';
    document.getElementById('progressArea').style.display = 'none';
    document.getElementById('sendBtn').style.display = 'inline-block';
    document.getElementById('cancelBtn').style.display = 'inline-block';
    document.getElementById('doneBtn').style.display = 'none';
}

function showCompletionState() {
    document.getElementById('doneBtn').style.display = 'inline-block';
}

async function startBulkNotification() {
    const formData = new FormData(document.getElementById('bulkNotificationForm'));

    const response = await fetch('{% url "students:bulk_notification_start" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'same-origin'
    });

    const data = await response.json();

    if (!data.success) {
        throw new Error(data.error || 'Failed to start bulk notification');
    }

    // Update progress display
    document.getElementById('progressTotal').textContent = data.total_recipients;
    updateProgressBar(0, `Starting ${data.notification_type} notification for ${data.total_recipients} recipients...`);

    return data.task_id;
}

async function executeBulkNotificationWithProgress(taskId) {
    // Start execution
    const executePromise = fetch(`{% url "students:bulk_notification_execute" task_id="TASK_ID" %}`.replace('TASK_ID', taskId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'same-origin'
    });

    // Start progress monitoring
    const progressPromise = monitorProgress(taskId);

    // Wait for both to complete
    const [executeResponse, progressResult] = await Promise.all([executePromise, progressPromise]);

    const executeData = await executeResponse.json();

    if (!executeData.success) {
        throw new Error(executeData.error || 'Failed to execute bulk notification');
    }

    return executeData;
}

async function monitorProgress(taskId) {
    const progressUrl = `{% url "students:bulk_notification_progress" task_id="TASK_ID" %}`.replace('TASK_ID', taskId);
    let lastStatus = '';

    while (true) {
        try {
            const response = await fetch(progressUrl, { credentials: 'same-origin' });
            const data = await response.json();

            if (!data) {
                throw new Error('Failed to get progress data');
            }
            if (data.error) {
                throw new Error(data.error);
            }

            updateProgressDisplay(data);

            // Check if completed or failed
            if (data.status === 'completed') {
                showCompletionState();
                break;
            } else if (data.status === 'failed') {
                throw new Error(data.error_message || 'Task failed');
            }

            // Continue polling
            await new Promise(resolve => setTimeout(resolve, 1000)); // Poll every 1 second

        } catch (error) {
            console.error('Progress monitoring error:', error);
            break;
        }
    }
}

function updateProgressDisplay(progressData) {
    const percentage = progressData.percentage || 0;
    const processed = progressData.processed_emails || 0;
    const total = progressData.total_emails || 0;
    const sent = progressData.sent_emails || 0;
    const failed = progressData.failed_emails || 0;

    // Update progress bar
    updateProgressBar(percentage, `Processing ${processed} of ${total} notifications...`);

    // Update stats
    document.getElementById('progressSent').textContent = sent;
    document.getElementById('progressFailed').textContent = failed;
    document.getElementById('progressTotal').textContent = total;

    // Show stats when we have data
    if (processed > 0) {
        document.getElementById('progressStats').style.display = 'block';
    }

    // Update status text based on progress
    let statusText = 'Preparing to send notifications...';
    if (progressData.status === 'starting') {
        statusText = 'Starting notification process...';
    } else if (progressData.status === 'sending') {
        statusText = `Sending notification ${processed} of ${total}...`;
        if (progressData.current_batch && progressData.total_batches) {
            statusText += ` (Batch ${progressData.current_batch}/${progressData.total_batches})`;
        }
    } else if (progressData.status === 'completed') {
        statusText = `Completed! Sent ${sent} notifications, ${failed} failed.`;
    }

    document.getElementById('progressText').textContent = statusText;
}

function updateProgressBar(percentage, text) {
    const progressBar = document.getElementById('progressBar');
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);

    if (text) {
        document.getElementById('progressText').textContent = text;
    }
}

// Notification type toggle handler
function handleNotificationTypeChange(type) {
    const emailFieldsGroup = document.getElementById('emailFieldsGroup');
    const smsFieldsGroup = document.getElementById('smsFieldsGroup');
    
    if (type === 'email') {
        emailFieldsGroup.style.display = 'block';
        smsFieldsGroup.style.display = 'none';
        
        // Make email fields required
        document.getElementById('emailSubject').required = true;
        document.getElementById('emailContent').required = true;
        document.getElementById('smsContent').required = false;
        
        // Initialize TinyMCE if not already done
        // Use setTimeout to ensure it runs after modal is fully shown
        setTimeout(function() {
            if (typeof tinymce !== 'undefined' && !tinymce.get('emailContent')) {
                initializeTinyMCE();
            }
        }, 100);
    } else if (type === 'sms') {
        emailFieldsGroup.style.display = 'none';
        smsFieldsGroup.style.display = 'block';
        
        // Make SMS fields required
        document.getElementById('emailSubject').required = false;
        document.getElementById('emailContent').required = false;
        document.getElementById('smsContent').required = true;
    }
}

// Initialize TinyMCE editor with image upload support
function initializeTinyMCE() {
    tinymce.init({
        selector: '.tinymce-editor',
        height: 400,
        menubar: false,
        branding: false,
        promotion: false,
        license_key: 'gpl',
        plugins: 'lists link image code help wordcount',
        toolbar: 'undo redo | bold italic underline | bullist numlist | link uploadimage | code | help',
        
        // Image upload configuration
        images_upload_url: '{% url "core:tinymce_upload" %}',
        automatic_uploads: true,
        images_reuse_filename: false,
        file_picker_types: 'image',
        paste_data_images: true, // Enable paste image support
        
        // Handle image uploads (paste, drag, or button click)
        images_upload_handler: function(blobInfo, progress) {
            return new Promise(function(resolve, reject) {
                const xhr = new XMLHttpRequest();
                xhr.withCredentials = false;
                xhr.open('POST', '{% url "core:tinymce_upload" %}');
                
                const formData = new FormData();
                formData.append('file', blobInfo.blob(), blobInfo.filename());
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                
                xhr.upload.onprogress = function(e) {
                    progress(e.loaded / e.total * 100);
                };
                
                xhr.onload = function() {
                    if (xhr.status === 403) {
                        reject({ message: 'HTTP Error: ' + xhr.status, remove: true });
                        return;
                    }
                    
                    if (xhr.status < 200 || xhr.status >= 300) {
                        reject('HTTP Error: ' + xhr.status);
                        return;
                    }
                    
                    let json;
                    try {
                        json = JSON.parse(xhr.responseText);
                    } catch (e) {
                        reject('Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    
                    if (!json || typeof json.location != 'string') {
                        reject('Invalid JSON: ' + xhr.responseText);
                        return;
                    }
                    
                    resolve(json.location);
                };
                
                xhr.onerror = function() {
                    reject('Image upload failed due to a network error.');
                };
                
                xhr.send(formData);
            });
        },
        
        content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; font-size: 14px; } img { max-width: 100%; height: auto; }',
        
        // Custom setup - add direct upload button
        setup: function(editor) {
            // Add custom upload image button that triggers file picker directly
            editor.ui.registry.addButton('uploadimage', {
                text: '',
                icon: 'image',
                tooltip: 'Upload Image',
                onAction: function() {
                    // Create hidden file input
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.style.display = 'none';
                    
                    input.onchange = function() {
                        const file = input.files[0];
                        if (file) {
                            // Show upload progress
                            editor.notificationManager.open({
                                text: 'Uploading image...',
                                type: 'info',
                                timeout: 3000
                            });
                            
                            // Upload the file
                            const formData = new FormData();
                            formData.append('file', file);
                            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
                            
                            fetch('{% url "core:tinymce_upload" %}', {
                                method: 'POST',
                                body: formData
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.location) {
                                    // Insert image into editor
                                    const imgHtml = '<img src="' + data.location + '" alt="' + file.name + '" style="max-width: 100%; height: auto;" />';
                                    editor.insertContent(imgHtml);
                                    
                                    editor.notificationManager.open({
                                        text: 'Image uploaded successfully!',
                                        type: 'success',
                                        timeout: 2000
                                    });
                                } else {
                                    throw new Error(data.error || 'Upload failed');
                                }
                            })
                            .catch(error => {
                                editor.notificationManager.open({
                                    text: 'Upload failed: ' + error.message,
                                    type: 'error',
                                    timeout: 5000
                                });
                            });
                        }
                    };
                    
                    // Trigger file selection
                    document.body.appendChild(input);
                    input.click();
                    document.body.removeChild(input);
                }
            });
            
            editor.on('change', function() {
                editor.save();
            });
        }
    });
}

// SMS character counter
document.addEventListener('DOMContentLoaded', function() {
    const smsContent = document.getElementById('smsContent');
    const smsCounter = document.getElementById('smsCounter');
    
    if (smsContent && smsCounter) {
        smsContent.addEventListener('input', function() {
            smsCounter.textContent = this.value.length;
            
            // Warning if over 160 chars
            if (this.value.length > 160) {
                smsCounter.parentElement.classList.add('text-danger');
            } else {
                smsCounter.parentElement.classList.remove('text-danger');
            }
        });
    }
    
    // Initialize on modal show
    const bulkNotificationModal = document.getElementById('bulkNotificationModal');
    if (bulkNotificationModal) {
        bulkNotificationModal.addEventListener('shown.bs.modal', function () {
            // Initialize TinyMCE when modal is shown
            if (typeof tinymce !== 'undefined') {
                initializeTinyMCE();
            }
        });
        
        // Clean up TinyMCE when modal is hidden
        bulkNotificationModal.addEventListener('hidden.bs.modal', function () {
            if (typeof tinymce !== 'undefined' && tinymce.get('emailContent')) {
                tinymce.get('emailContent').remove();
            }
        });
    }
});
</script>
{% endblock %}
