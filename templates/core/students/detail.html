{% extends 'base.html' %}
{% load static %}

{% block title %}{{ student.first_name }} {{ student.last_name }} - Student Details - EduPulse{% endblock %}

{% block extra_css %}
<style>
    .tag-badge {
        font-size: 0.75rem;
        margin-right: 2px;
        margin-bottom: 2px;
    }

    /* Tag selection in modal */
    .tag-selection-item {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .tag-selection-item:hover {
        background-color: #f8f9fa;
    }

    .tag-selection-item.selected {
        background-color: #e3f2fd;
        border-color: #1976d2;
    }

    .tag-selection-item .tag-info {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .tag-count {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* Tag suggestions styles */
    .dropdown-item.tag-option {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.55rem 0.85rem;
        cursor: pointer;
        border: none;
        background: transparent;
        white-space: normal;
        width: 100%;
        text-align: left;
        border-left: 3px solid transparent;
        transition: background-color 0.15s ease, border-color 0.15s ease;
    }

    .dropdown-item.tag-option:hover {
        background-color: #eef2ff;
        border-left-color: #4566ff;
    }

    .dropdown-item.tag-option .badge {
        padding: 0.4rem 0.6rem;
        font-size: 0.75rem;
        border-radius: 999px;
        min-width: 60px;
        text-align: center;
    }

    .dropdown-item.tag-option small {
        margin-left: auto;
        color: #64748b;
        font-size: 0.75rem;
    }

    /* Search functionality */
    .dropdown-empty-state {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<!-- Standard Detail Page Header -->
<div class="mb-3">
    <a href="{% url 'students:student_list' %}" class="text-decoration-none text-muted">
        <i class="fas fa-arrow-left me-2"></i>Back to Students
    </a>
</div>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h2 fw-bold mb-2">{{ student.first_name }} {{ student.last_name }}</h1>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="status-badge {% if student.is_active %}status-active{% else %}status-inactive{% endif %}">
                <i class="fas fa-{% if student.is_active %}check-circle{% else %}times-circle{% endif %} me-1"></i>
                {% if student.is_active %}Active Student{% else %}Inactive Student{% endif %}
            </span>
            {% if student.level %}
            <span class="badge bg-info text-white px-3 py-2">
                <i class="fas fa-layer-group me-1"></i>{{ student.level.name }}
            </span>
            {% endif %}
            {% if enrollments.count > 0 %}
            <span class="badge bg-primary text-white px-3 py-2">
                <i class="fas fa-graduation-cap me-1"></i>{{ enrollments.count }} Enrollment{{ enrollments.count|pluralize }}
            </span>
            {% endif %}
        </div>
    </div>
    <div class="d-flex flex-column flex-sm-row gap-2">
        <a href="{% url 'students:student_edit' student.pk %}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit Student
        </a>
        <button type="button" class="btn btn-success" onclick="openNotificationModal([{{ student.pk }}])">
            <i class="fas fa-paper-plane me-2"></i>Send Notification
        </button>
    </div>
</div>

<div class="row">
    <!-- Student Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Personal Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Name:</strong></div>
                    <div class="col-sm-8">{{ student.first_name }} {{ student.last_name }}</div>
                </div>
                
                {% if student.birth_date %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Date of Birth:</strong></div>
                    <div class="col-sm-8">{{ student.birth_date|date:"d F Y" }}</div>
                </div>
                {% endif %}
                
                {% if student.contact_email %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Contact Email:</strong></div>
                    <div class="col-sm-8">
                        <a href="mailto:{{ student.contact_email }}">{{ student.contact_email }}</a>
                        {% if student.guardian_name %}
                            <br><small class="text-muted">Guardian contact</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if student.contact_phone %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Contact Phone:</strong></div>
                    <div class="col-sm-8">
                        <a href="tel:{{ student.contact_phone }}">{{ student.contact_phone }}</a>
                        {% if student.guardian_name %}
                            <br><small class="text-muted">Guardian contact</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if student.address %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Address:</strong></div>
                    <div class="col-sm-8">{{ student.address|linebreaksbr }}</div>
                </div>
                {% endif %}

                <!-- Student Level Information -->
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Student Level:</strong></div>
                    <div class="col-sm-8">
                        {% if student.level %}
                            <span class="badge bg-info text-white px-3 py-2">
                                <i class="fas fa-layer-group me-1"></i>{{ student.level.name }}
                            </span>
                            {% if student.level.description %}
                                <br><small class="text-muted">{{ student.level.description }}</small>
                            {% endif %}
                        {% else %}
                            <span class="text-muted">No level assigned</span>
                        {% endif %}
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Status:</strong></div>
                    <div class="col-sm-8">
                        <span class="status-badge {% if student.is_active %}status-active{% else %}status-inactive{% endif %}">
                            {% if student.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Registered:</strong></div>
                    <div class="col-sm-8">{{ student.created_at|date:"d F Y g:i A" }}</div>
                </div>
                
                <div class="row">
                    <div class="col-sm-4"><strong>Last Updated:</strong></div>
                    <div class="col-sm-8">{{ student.updated_at|date:"d F Y g:i A" }}</div>
                </div>
            </div>
        </div>
        <!-- Tags Management -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Student Tags</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openTagManagementModal()">
                    <i class="fas fa-tag"></i> Manage Tags
                </button>
            </div>
            <div class="card-body">
                <div id="studentTagsContainer">
                    {% if student.tags.all %}
                        {% for tag in student.tags.all %}
                        <span class="badge tag-badge me-2 mb-2" style="background-color: {{ tag.colour }};" id="student-tag-{{ tag.id }}">
                            {{ tag.name }}
                            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.65rem;"
                                    onclick="removeTagFromStudent({{ tag.id }}, '{{ tag.name|escapejs }}')"
                                    title="Remove tag"></button>
                        </span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted" id="no-tags-message">No tags assigned to this student</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Guardian Information -->
        {% if student.guardian_name %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Guardian Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Name:</strong></div>
                    <div class="col-sm-8">{{ student.guardian_name }}</div>
                </div>
                
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-1"></i>
                    The contact details above belong to this guardian as the student is under 18.
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Additional Information -->
        {% if student.reference %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-4"><strong>Reference:</strong></div>
                    <div class="col-sm-8">{{ student.reference }}</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Enrollments and Activity -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Course Enrollments</h5>
                <small class="text-muted">({{ enrollments.count }} enrollments)</small>
            </div>
            <div class="card-body">
                {% if enrollments %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in enrollments|slice:":10" %}
                                <tr>
                                    <td>
                                        <strong>{{ enrollment.course.name }}</strong>
                                        <br>
                                        <small class="text-muted">{% load price_tags %}{% price_with_gst_label enrollment.course.price %}</small>
                                    </td>
                                    <td>
                                        <span class="badge {% if enrollment.status == 'enrolled' %}bg-success{% elif enrollment.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ enrollment.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ enrollment.created_at|date:"d/m/Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if enrollments.count > 10 %}
                    <div class="text-center mt-3">
                        <a href="{% url 'enrollment:enrollment_list' %}?student={{ student.pk }}" class="btn btn-sm btn-outline-primary">
                            View All Enrollments ({{ enrollments.count }})
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">No course enrollments yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Attendance -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Recent Attendance</h5>
            </div>
            <div class="card-body">
                {% if attendances %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in attendances %}
                                <tr>
                                    <td>
                                        <strong>{{ attendance.class_instance.course.name }}</strong>
                                    </td>
                                    <td>{{ attendance.attendance_time|date:"d/m/Y g:i A" }}</td>
                                    <td>
                                        <span class="badge {% if attendance.status == 'present' %}bg-success{% elif attendance.status == 'late' %}bg-warning{% elif attendance.status == 'unmarked' %}bg-secondary{% else %}bg-danger{% endif %}">
                                            {{ attendance.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'enrollment:attendance_list' %}?student={{ student.pk }}" class="btn btn-sm btn-outline-primary">
                            View All Attendance Records
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">No attendance records yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'enrollment:enrollment_list' %}?student={{ student.pk }}" class="btn btn-outline-info">View All Enrollments</a>
                    <a href="{% url 'enrollment:attendance_list' %}?student={{ student.pk }}" class="btn btn-outline-success">View Attendance History</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Unified Notification Modal (shared with student list) -->
{% include "core/students/includes/notification_modal.html" %}

<!-- Tag Management Modal -->
<div class="modal fade" id="tagManagementModal" tabindex="-1" aria-labelledby="tagManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagManagementModalLabel">Manage Tags for {{ student.first_name }} {{ student.last_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Alert container -->
                <div id="tagAlertContainer"></div>
                
                <!-- Current Tags -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Current Tags</label>
                    <div id="currentTagsDisplay" class="border rounded p-3 bg-light" style="min-height: 50px;">
                        <!-- Current tags will be rendered here as removable pills -->
                    </div>
                </div>

                <!-- Add Tag Input -->
                <div class="mb-3">
                    <label for="tagSearchInput" class="form-label fw-semibold">Add Tag</label>
                    <div class="position-relative">
                        <input type="text" 
                               class="form-control" 
                               id="tagSearchInput" 
                               placeholder="Type to search or create new tag..."
                               autocomplete="off">
                        <div id="tagSuggestionsDropdown" 
                             class="position-absolute bg-white border rounded shadow-sm w-100" 
                             style="display: none; z-index: 1050; max-height: 250px; overflow-y: auto;">
                            <!-- Suggestions will be rendered here -->
                        </div>
                    </div>
                    <div class="form-text">
                        <i class="fas fa-info-circle text-muted me-1"></i>
                        Type a tag name and press Enter or click a suggestion. New tags are created automatically.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================
// Tag Management - Modern Autocomplete Design
// ============================================

let currentStudentTags = [];
let tagSearchTimeout = null;
let tagModalInstance = null;

// Initialize current tags from server-rendered data
function initCurrentStudentTags() {
    currentStudentTags = [];
    {% for tag in student.tags.all %}
    currentStudentTags.push({
        id: {{ tag.id }},
        name: '{{ tag.name|escapejs }}',
        colour: '{{ tag.colour|escapejs }}'
    });
    {% endfor %}
}

// Open tag management modal
function openTagManagementModal() {
    initCurrentStudentTags();
    renderCurrentTags();
    
    // Clear search input
    const searchInput = document.getElementById('tagSearchInput');
    searchInput.value = '';
    hideTagSuggestions();
    
    // Show modal
    if (!tagModalInstance) {
        tagModalInstance = new bootstrap.Modal(document.getElementById('tagManagementModal'));
    }
    tagModalInstance.show();
    
    // Focus on search input after modal opens
    document.getElementById('tagManagementModal').addEventListener('shown.bs.modal', function () {
        searchInput.focus();
    }, { once: true });
}

// Render current tags as removable pills
function renderCurrentTags() {
    const container = document.getElementById('currentTagsDisplay');
    
    if (currentStudentTags.length === 0) {
        container.innerHTML = '<span class="text-muted fst-italic">No tags assigned</span>';
        return;
    }
    
    let html = '<div class="d-flex flex-wrap gap-2">';
    currentStudentTags.forEach(tag => {
        html += `
            <span class="badge d-inline-flex align-items-center py-2 px-3" 
                  style="background-color: ${tag.colour}; font-size: 0.875rem;">
                ${escapeHtml(tag.name)}
                <button type="button" 
                        class="btn-close btn-close-white ms-2" 
                        style="font-size: 0.6rem;"
                        onclick="removeTagFromModal(${tag.id}, '${escapeHtml(tag.name)}')"
                        title="Remove tag"
                        aria-label="Remove ${escapeHtml(tag.name)}"></button>
            </span>
        `;
    });
    html += '</div>';
    
    container.innerHTML = html;
}

// Search input event handlers
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('tagSearchInput');
    
    if (searchInput) {
        // Handle input with debounce
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(tagSearchTimeout);
            
            if (query.length === 0) {
                hideTagSuggestions();
                return;
            }
            
            tagSearchTimeout = setTimeout(() => {
                fetchTagSuggestions(query);
            }, 200);
        });
        
        // Handle Enter key
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const dropdown = document.getElementById('tagSuggestionsDropdown');
                const firstItem = dropdown.querySelector('.tag-suggestion-item');
                if (firstItem) {
                    firstItem.click();
                } else if (this.value.trim()) {
                    // Add as new tag if no suggestions
                    addTagByName(this.value.trim());
                }
            } else if (e.key === 'Escape') {
                hideTagSuggestions();
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#tagSearchInput') && !e.target.closest('#tagSuggestionsDropdown')) {
                hideTagSuggestions();
            }
        });
    }
});

// Fetch tag suggestions from API
async function fetchTagSuggestions(query) {
    try {
        const response = await fetch(`{% url "students:suggest_tag_name" %}?q=${encodeURIComponent(query)}&limit=8`);
        const data = await response.json();
        
        if (data.success) {
            renderTagSuggestions(data.suggestions, query);
        }
    } catch (error) {
        console.error('Error fetching tag suggestions:', error);
    }
}

// Render tag suggestions dropdown
function renderTagSuggestions(suggestions, query) {
    const dropdown = document.getElementById('tagSuggestionsDropdown');
    
    // Filter out tags that student already has
    const currentTagNames = new Set(currentStudentTags.map(t => t.name.toLowerCase()));
    const filteredSuggestions = suggestions.filter(s => !currentTagNames.has(s.name.toLowerCase()));
    
    if (filteredSuggestions.length === 0) {
        // Check if query matches an existing tag the student already has
        if (currentTagNames.has(query.toLowerCase())) {
            dropdown.innerHTML = `
                <div class="p-3 text-center text-muted">
                    <i class="fas fa-check-circle text-success me-1"></i>
                    This tag is already assigned
                </div>
            `;
        } else if (query.trim()) {
            // Show create option for non-matching query
            dropdown.innerHTML = `
                <div class="dropdown-item tag-suggestion-item d-flex align-items-center gap-2 py-2 px-3" 
                     style="cursor: pointer;"
                     onclick="addTagByName('${escapeHtml(query.trim())}')">
                    <i class="fas fa-plus-circle text-success"></i>
                    <span>Create <strong>"${escapeHtml(query.trim())}"</strong></span>
                    <span class="badge bg-secondary ms-auto">new</span>
                </div>
            `;
        } else {
            dropdown.innerHTML = '<div class="p-3 text-center text-muted">No matching tags</div>';
        }
        dropdown.style.display = 'block';
        return;
    }
    
    let html = '';
    filteredSuggestions.forEach((suggestion, index) => {
        const isNew = !suggestion.exists;
        
        if (isNew) {
            // Create new tag option
            html += `
                <div class="dropdown-item tag-suggestion-item d-flex align-items-center gap-2 py-2 px-3" 
                     style="cursor: pointer; border-left: 3px solid ${suggestion.colour};"
                     onclick="addTagByName('${escapeHtml(suggestion.name)}')">
                    <i class="fas fa-plus-circle text-success"></i>
                    <span>Create <strong>"${escapeHtml(suggestion.name)}"</strong></span>
                    <span class="badge bg-secondary ms-auto">new</span>
                </div>
            `;
        } else {
            // Existing tag option
            html += `
                <div class="dropdown-item tag-suggestion-item d-flex align-items-center gap-2 py-2 px-3" 
                     style="cursor: pointer; border-left: 3px solid ${suggestion.colour};"
                     onclick="addTagById(${suggestion.id || 0}, '${escapeHtml(suggestion.name)}')">
                    <span class="badge" style="background-color: ${suggestion.colour};">${escapeHtml(suggestion.name)}</span>
                    <small class="text-muted ms-auto">${suggestion.student_count} student${suggestion.student_count !== 1 ? 's' : ''}</small>
                </div>
            `;
        }
    });
    
    dropdown.innerHTML = html;
    dropdown.style.display = 'block';
}

// Hide suggestions dropdown
function hideTagSuggestions() {
    const dropdown = document.getElementById('tagSuggestionsDropdown');
    if (dropdown) {
        dropdown.style.display = 'none';
    }
}

// Add tag by ID (existing tag)
async function addTagById(tagId, tagName) {
    await performTagOperation('add', { tag_id: tagId }, tagName);
}

// Add tag by name (may create new tag)
async function addTagByName(tagName) {
    await performTagOperation('add', { tag_name: tagName }, tagName);
}

// Remove tag from modal
async function removeTagFromModal(tagId, tagName) {
    await performTagOperation('remove', { tag_id: tagId }, tagName);
}

// Perform add/remove tag operation
async function performTagOperation(operation, tagData, tagName) {
    try {
        const formData = new FormData();
        formData.append('operation', operation);
        
        if (tagData.tag_id) {
            formData.append('tag_id', tagData.tag_id);
        }
        if (tagData.tag_name) {
            formData.append('tag_name', tagData.tag_name);
        }
        
        const response = await fetch('{% url "students:student_tag_management" student.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Update current tags list
            currentStudentTags = data.current_tags;
            renderCurrentTags();
            updateMainPageTags();
            
            // Clear search input and hide suggestions
            const searchInput = document.getElementById('tagSearchInput');
            searchInput.value = '';
            hideTagSuggestions();
            
            // Show success message
            const message = data.created 
                ? `Tag "${data.tag.name}" created and added`
                : `Tag "${data.tag.name}" ${operation === 'add' ? 'added' : 'removed'}`;
            showTagAlert(message, 'success');
            
            // Refocus on search input for quick additions
            if (operation === 'add') {
                searchInput.focus();
            }
        } else {
            showTagAlert(data.error || 'Operation failed', 'danger');
        }
    } catch (error) {
        console.error('Tag operation error:', error);
        showTagAlert('An error occurred. Please try again.', 'danger');
    }
}

// Update main page tag display
function updateMainPageTags() {
    const container = document.getElementById('studentTagsContainer');
    
    if (currentStudentTags.length === 0) {
        container.innerHTML = '<span class="text-muted" id="no-tags-message">No tags assigned to this student</span>';
        return;
    }
    
    let html = '';
    currentStudentTags.forEach(tag => {
        html += `
            <span class="badge tag-badge me-2 mb-2" style="background-color: ${tag.colour};" id="student-tag-${tag.id}">
                ${escapeHtml(tag.name)}
                <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.65rem;"
                        onclick="removeTagFromStudent(${tag.id}, '${escapeHtml(tag.name)}')"
                        title="Remove tag"></button>
            </span>
        `;
    });
    
    container.innerHTML = html;
}

// Function for removing tags directly from main page (with confirmation)
async function removeTagFromStudent(tagId, tagName) {
    if (!confirm(`Are you sure you want to remove the tag "${tagName}" from this student?`)) {
        return;
    }
    
    try {
        const formData = new FormData();
        formData.append('operation', 'remove');
        formData.append('tag_id', tagId);
        
        const response = await fetch('{% url "students:student_tag_management" student.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            currentStudentTags = data.current_tags;
            updateMainPageTags();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Error removing tag:', error);
        alert('An error occurred while removing the tag');
    }
}

// Show alert in modal
function showTagAlert(message, type) {
    const container = document.getElementById('tagAlertContainer');
    const alertId = 'alert-' + Date.now();
    
    const alertHtml = `
        <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show py-2" role="alert">
            <small>${escapeHtml(message)}</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close" style="padding: 0.5rem;"></button>
        </div>
    `;
    
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        const alertEl = document.getElementById(alertId);
        if (alertEl) {
            alertEl.remove();
        }
    }, 3000);
}

// Utility: Escape HTML to prevent XSS
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// Detail Page Notification Form Handler
// ============================================

// Store the student ID for this page
const currentStudentId = {{ student.pk }};

// Handle form submission for the notification modal
document.addEventListener('DOMContentLoaded', function() {
    const notificationForm = document.getElementById('notificationForm');
    if (notificationForm) {
        notificationForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            await submitNotificationForm();
        });
    }
});

async function submitNotificationForm() {
    const notificationType = document.getElementById('notificationType').value;
    
    // Validate based on type
    if (notificationType === 'email') {
        const subject = document.getElementById('notificationEmailSubject').value;
        const content = tinymce.get('notificationEmailContent') ? tinymce.get('notificationEmailContent').getContent() : '';

        if (!subject.trim()) {
            alert('Please enter an email subject.');
            return;
        }
        if (!content.trim()) {
            alert('Please enter email content.');
            return;
        }
        // Sync TinyMCE content to textarea
        tinymce.triggerSave();
    } else if (notificationType === 'sms') {
        const content = document.getElementById('notificationSmsContent').value;
        if (!content.trim()) {
            alert('Please enter SMS message.');
            return;
        }
        if (content.length > 160) {
            alert('SMS messages cannot exceed 160 characters. Please shorten your message.');
            return;
        }
    }

    // Show progress
    showNotificationProgressArea();

    try {
        // Start the notification task
        const taskId = await startNotificationTask();
        
        // Execute and monitor progress
        await executeNotificationWithProgress(taskId);
        
    } catch (error) {
        console.error('Notification error:', error);
        showNotificationFormFields();
        alert('An error occurred while sending the notification. Please try again.');
    }
}

async function startNotificationTask() {
    const formData = new FormData(document.getElementById('notificationForm'));
    
    const response = await fetch('{% url "students:bulk_notification_start" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'same-origin'
    });

    const data = await response.json();

    if (!data.success) {
        throw new Error(data.error || 'Failed to start notification');
    }

    // Update progress display
    document.getElementById('notificationProgressTotal').textContent = data.total_recipients;
    updateNotificationProgressBar(0, `Starting ${data.notification_type} notification for ${data.total_recipients} recipient(s)...`);

    return data.task_id;
}

async function executeNotificationWithProgress(taskId) {
    // Start execution
    const executePromise = fetch(`{% url "students:bulk_notification_execute" task_id="TASK_ID" %}`.replace('TASK_ID', taskId), {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        credentials: 'same-origin'
    });

    // Start progress monitoring
    const progressPromise = monitorNotificationProgress(taskId);

    // Wait for both to complete
    const [executeResponse, progressResult] = await Promise.all([executePromise, progressPromise]);

    const executeData = await executeResponse.json();

    if (!executeData.success) {
        throw new Error(executeData.error || 'Failed to execute notification');
    }

    return executeData;
}

async function monitorNotificationProgress(taskId) {
    const progressUrl = `{% url "students:bulk_notification_progress" task_id="TASK_ID" %}`.replace('TASK_ID', taskId);

    while (true) {
        try {
            const response = await fetch(progressUrl, { credentials: 'same-origin' });
            const data = await response.json();

            if (!data) {
                throw new Error('Failed to get progress data');
            }
            if (data.error) {
                throw new Error(data.error);
            }

            updateNotificationProgressDisplay(data);

            // Check if completed or failed
            if (data.status === 'completed') {
                showNotificationCompletionState();
                break;
            } else if (data.status === 'failed') {
                throw new Error(data.error_message || 'Task failed');
            }

            // Continue polling
            await new Promise(resolve => setTimeout(resolve, 1000)); // Poll every 1 second

        } catch (error) {
            console.error('Progress monitoring error:', error);
            break;
        }
    }
}
</script>

{% endblock %}

{% block extra_js %}
<!-- TinyMCE Library for notification modal -->
<script src="{% static 'tinymce/tinymce.min.js' %}"></script>
{% endblock %}
