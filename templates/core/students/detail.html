{% extends 'base.html' %}
{% load static %}

{% block title %}{{ student.first_name }} {{ student.last_name }} - Student Details - EduPulse{% endblock %}

{% block content %}
<!-- Standard Detail Page Header -->
<div class="mb-3">
    <a href="{% url 'students:student_list' %}" class="text-decoration-none text-muted">
        <i class="fas fa-arrow-left me-2"></i>Back to Students
    </a>
</div>

<div class="d-flex justify-content-between align-items-start mb-4">
    <div>
        <h1 class="h2 fw-bold mb-2">{{ student.first_name }} {{ student.last_name }}</h1>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <span class="status-badge {% if student.is_active %}status-active{% else %}status-inactive{% endif %}">
                <i class="fas fa-{% if student.is_active %}check-circle{% else %}times-circle{% endif %} me-1"></i>
                {% if student.is_active %}Active Student{% else %}Inactive Student{% endif %}
            </span>
            {% if enrollments.count > 0 %}
            <span class="badge bg-primary text-white px-3 py-2">
                <i class="fas fa-graduation-cap me-1"></i>{{ enrollments.count }} Enrollment{{ enrollments.count|pluralize }}
            </span>
            {% endif %}
        </div>
    </div>
    <div class="d-flex flex-column flex-sm-row gap-2">
        <a href="{% url 'students:student_edit' student.pk %}" class="btn btn-primary">
            <i class="fas fa-edit me-2"></i>Edit Student
        </a>
        <button type="button" class="btn btn-success" onclick="openNotificationModal([{{ student.pk }}])">
            <i class="fas fa-paper-plane me-2"></i>Send Notification
        </button>
    </div>
</div>

<div class="row">
    <!-- Student Information -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Personal Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Name:</strong></div>
                    <div class="col-sm-8">{{ student.first_name }} {{ student.last_name }}</div>
                </div>
                
                {% if student.birth_date %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Date of Birth:</strong></div>
                    <div class="col-sm-8">{{ student.birth_date|date:"d F Y" }}</div>
                </div>
                {% endif %}
                
                {% if student.contact_email %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Contact Email:</strong></div>
                    <div class="col-sm-8">
                        <a href="mailto:{{ student.contact_email }}">{{ student.contact_email }}</a>
                        {% if student.guardian_name %}
                            <br><small class="text-muted">Guardian contact</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if student.contact_phone %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Contact Phone:</strong></div>
                    <div class="col-sm-8">
                        <a href="tel:{{ student.contact_phone }}">{{ student.contact_phone }}</a>
                        {% if student.guardian_name %}
                            <br><small class="text-muted">Guardian contact</small>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                {% if student.address %}
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Address:</strong></div>
                    <div class="col-sm-8">{{ student.address|linebreaksbr }}</div>
                </div>
                {% endif %}
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Status:</strong></div>
                    <div class="col-sm-8">
                        <span class="status-badge {% if student.is_active %}status-active{% else %}status-inactive{% endif %}">
                            {% if student.is_active %}Active{% else %}Inactive{% endif %}
                        </span>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Registered:</strong></div>
                    <div class="col-sm-8">{{ student.created_at|date:"d F Y g:i A" }}</div>
                </div>
                
                <div class="row">
                    <div class="col-sm-4"><strong>Last Updated:</strong></div>
                    <div class="col-sm-8">{{ student.updated_at|date:"d F Y g:i A" }}</div>
                </div>
            </div>
        </div>
        <!-- Tags Management -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Student Tags</h5>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="openTagManagementModal()">
                    <i class="fas fa-tag"></i> Manage Tags
                </button>
            </div>
            <div class="card-body">
                <div id="studentTagsContainer">
                    {% if student.tags.all %}
                        {% for tag in student.tags.all %}
                        <span class="badge tag-badge me-2 mb-2" style="background-color: {{ tag.colour }};" id="student-tag-{{ tag.id }}">
                            {{ tag.name }}
                            <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.65rem;"
                                    onclick="removeTagFromStudent({{ tag.id }}, '{{ tag.name|escapejs }}')"
                                    title="Remove tag"></button>
                        </span>
                        {% endfor %}
                    {% else %}
                        <span class="text-muted" id="no-tags-message">No tags assigned to this student</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Guardian Information -->
        {% if student.guardian_name %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Guardian Information</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>Name:</strong></div>
                    <div class="col-sm-8">{{ student.guardian_name }}</div>
                </div>
                
                <div class="alert alert-info small">
                    <i class="fas fa-info-circle me-1"></i>
                    The contact details above belong to this guardian as the student is under 18.
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Additional Information -->
        {% if student.reference %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Additional Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-sm-4"><strong>Reference:</strong></div>
                    <div class="col-sm-8">{{ student.reference }}</div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Enrollments and Activity -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Course Enrollments</h5>
                <small class="text-muted">({{ enrollments.count }} enrollments)</small>
            </div>
            <div class="card-body">
                {% if enrollments %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Status</th>
                                    <th>Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enrollment in enrollments|slice:":10" %}
                                <tr>
                                    <td>
                                        <strong>{{ enrollment.course.name }}</strong>
                                        <br>
                                        <small class="text-muted">{% load price_tags %}{% price_with_gst_label enrollment.course.price %}</small>
                                    </td>
                                    <td>
                                        <span class="badge {% if enrollment.status == 'enrolled' %}bg-success{% elif enrollment.status == 'pending' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ enrollment.get_status_display }}
                                        </span>
                                    </td>
                                    <td>{{ enrollment.created_at|date:"d/m/Y" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    {% if enrollments.count > 10 %}
                    <div class="text-center mt-3">
                        <a href="{% url 'enrollment:enrollment_list' %}?student={{ student.pk }}" class="btn btn-sm btn-outline-primary">
                            View All Enrollments ({{ enrollments.count }})
                        </a>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">No course enrollments yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Recent Attendance -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Recent Attendance</h5>
            </div>
            <div class="card-body">
                {% if attendances %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Course</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for attendance in attendances %}
                                <tr>
                                    <td>
                                        <strong>{{ attendance.class_instance.course.name }}</strong>
                                    </td>
                                    <td>{{ attendance.attendance_time|date:"d/m/Y g:i A" }}</td>
                                    <td>
                                        <span class="badge {% if attendance.status == 'present' %}bg-success{% elif attendance.status == 'late' %}bg-warning{% else %}bg-danger{% endif %}">
                                            {{ attendance.get_status_display }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="text-center mt-3">
                        <a href="{% url 'enrollment:attendance_list' %}?student={{ student.pk }}" class="btn btn-sm btn-outline-primary">
                            View All Attendance Records
                        </a>
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted mb-0">No attendance records yet</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'enrollment:enrollment_list' %}?student={{ student.pk }}" class="btn btn-outline-info">View All Enrollments</a>
                    <a href="{% url 'enrollment:attendance_list' %}?student={{ student.pk }}" class="btn btn-outline-success">View Attendance History</a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Modal -->
<div class="modal fade" id="notificationModal" tabindex="-1" aria-labelledby="notificationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="notificationModalLabel">Send Notification</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Quota Information -->
                <div class="row mb-3" id="quotaInfo" style="display: none;">
                    <div class="col-md-6">
                        <div class="quota-display">
                            <strong>Email Quota:</strong>
                            <span id="emailQuota">Loading...</span>
                            <div class="progress mt-1">
                                <div class="progress-bar" id="emailProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="quota-display">
                            <strong>SMS Quota:</strong>
                            <span id="smsQuota">Loading...</span>
                            <div class="progress mt-1">
                                <div class="progress-bar" id="smsProgressBar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recipient Information -->
                <div class="alert alert-info" id="recipientInfo">
                    <h6><i class="fas fa-users me-2"></i>Recipients</h6>
                    <div id="recipientList">Loading recipient information...</div>
                </div>
                
                <!-- Notification Form -->
                <form id="notificationForm">
                    {% csrf_token %}
                    <input type="hidden" id="studentIds" name="student_ids">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="notificationType" class="form-label">Notification Type</label>
                                <select class="form-select" id="notificationType" name="notification_type" onchange="toggleEmailFields()">
                                    <option value="email">Email Only</option>
                                    <option value="sms">SMS Only</option>
                                    <option value="both">Both Email & SMS</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="messageType" class="form-label">Message Type</label>
                                <select class="form-select" id="messageType" name="message_type">
                                    <option value="general">General Message</option>
                                    <option value="course_reminder">Course Reminder</option>
                                    <option value="attendance_notice">Attendance Notice</option>
                                    <option value="welcome">Welcome Message</option>
                                    <option value="enrollment_confirm">Enrollment Confirmation</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Email Subject Field -->
                    <div class="mb-3" id="subjectField">
                        <label for="subject" class="form-label">Email Subject</label>
                        <input type="text" class="form-control" id="subject" name="subject" placeholder="Enter email subject">
                    </div>
                    
                    <!-- Message Content -->
                    <div class="mb-3">
                        <label for="message" class="form-label">Message Content</label>
                        <textarea class="form-control" id="message" name="message" rows="5" placeholder="Enter your message here..."></textarea>
                        <div class="form-text">
                            <span id="charCount">0</span>/160 characters (SMS limit)
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="sendNotificationBtn" onclick="sendNotification()">
                    <i class="fas fa-paper-plane me-2"></i>Send Notification
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Tag Management Modal -->
<div class="modal fade" id="tagManagementModal" tabindex="-1" aria-labelledby="tagManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tagManagementModalLabel">Manage Tags for {{ student.first_name }} {{ student.last_name }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Current Tags -->
                <div class="mb-4">
                    <h6>Current Tags:</h6>
                    <div id="currentTagsDisplay" class="border rounded p-3 bg-light">
                        <!-- Current tags will be updated here -->
                    </div>
                </div>

                <!-- Add New Tags -->
                <div class="mb-3">
                    <h6>Add Tags:</h6>
                    <div id="availableTagsContainer" style="max-height: 200px; overflow-y: auto;">
                        <!-- Available tags will be loaded here -->
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i> Loading available tags...
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
// Notification Modal JavaScript
let selectedStudentIds = [];
let availableTagsData = [];
let currentStudentTags = [];

// Tag Management Functions
async function openTagManagementModal() {
    // Load current student tags and available tags
    await loadCurrentStudentTags();
    await loadAvailableTagsForStudent();

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('tagManagementModal'));
    modal.show();
}

async function loadCurrentStudentTags() {
    // Get current tags from the page
    currentStudentTags = [];
    {% for tag in student.tags.all %}
    currentStudentTags.push({
        id: {{ tag.id }},
        name: '{{ tag.name|escapejs }}',
        colour: '{{ tag.colour|escapejs }}'
    });
    {% endfor %}

    updateCurrentTagsDisplay();
}

function updateCurrentTagsDisplay() {
    const container = document.getElementById('currentTagsDisplay');

    if (currentStudentTags.length === 0) {
        container.innerHTML = '<span class="text-muted">No tags assigned</span>';
        return;
    }

    let html = '';
    currentStudentTags.forEach(tag => {
        html += `
            <span class="badge me-2 mb-2" style="background-color: ${tag.colour};">
                ${tag.name}
                <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.65rem;"
                        onclick="removeTagFromStudentModal(${tag.id})" title="Remove tag"></button>
            </span>
        `;
    });

    container.innerHTML = html;
}

async function loadAvailableTagsForStudent() {
    try {
        const response = await fetch('{% url "students:get_available_tags" %}');
        const data = await response.json();

        if (data.success) {
            availableTagsData = data.tags;
            renderAvailableTagsForStudent();
        } else {
            throw new Error(data.error || 'Failed to load tags');
        }
    } catch (error) {
        console.error('Error loading available tags:', error);
        document.getElementById('availableTagsContainer').innerHTML =
            '<div class="text-danger">Error loading tags. Please try again.</div>';
    }
}

function renderAvailableTagsForStudent() {
    const container = document.getElementById('availableTagsContainer');

    // Filter out tags that student already has
    const currentTagIds = new Set(currentStudentTags.map(tag => tag.id));
    const availableTags = availableTagsData.filter(tag => !currentTagIds.has(tag.id));

    if (availableTags.length === 0) {
        container.innerHTML = '<div class="text-muted">All available tags are already assigned to this student.</div>';
        return;
    }

    let html = '';
    availableTags.forEach(tag => {
        html += `
            <div class="d-flex justify-content-between align-items-center border rounded p-2 mb-2 tag-available-item"
                 style="cursor: pointer;" onclick="addTagToStudentModal(${tag.id})">
                <div>
                    <span class="badge" style="background-color: ${tag.colour};">${tag.name}</span>
                </div>
                <div>
                    <button type="button" class="btn btn-sm btn-outline-success">
                        <i class="fas fa-plus"></i> Add
                    </button>
                </div>
            </div>
        `;
    });

    container.innerHTML = html;
}

async function addTagToStudentModal(tagId) {
    try {
        const formData = new FormData();
        formData.append('operation', 'add');
        formData.append('tag_id', tagId);

        const response = await fetch('{% url "students:student_tag_management" student.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            // Update current tags list
            currentStudentTags = data.current_tags;
            updateCurrentTagsDisplay();
            renderAvailableTagsForStudent();

            // Update main page tag display
            updateMainPageTags();

            // Show success message
            showTagMessage(`Tag "${data.tag.name}" added successfully`, 'success');
        } else {
            showTagMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        console.error('Error adding tag:', error);
        showTagMessage('An error occurred while adding the tag', 'danger');
    }
}

async function removeTagFromStudentModal(tagId) {
    try {
        const formData = new FormData();
        formData.append('operation', 'remove');
        formData.append('tag_id', tagId);

        const response = await fetch('{% url "students:student_tag_management" student.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            // Update current tags list
            currentStudentTags = data.current_tags;
            updateCurrentTagsDisplay();
            renderAvailableTagsForStudent();

            // Update main page tag display
            updateMainPageTags();

            // Show success message
            showTagMessage(`Tag "${data.tag.name}" removed successfully`, 'success');
        } else {
            showTagMessage(`Error: ${data.error}`, 'danger');
        }
    } catch (error) {
        console.error('Error removing tag:', error);
        showTagMessage('An error occurred while removing the tag', 'danger');
    }
}

// Function for removing tags directly from main page
async function removeTagFromStudent(tagId, tagName) {
    if (!confirm(`Are you sure you want to remove the tag "${tagName}" from this student?`)) {
        return;
    }

    try {
        const formData = new FormData();
        formData.append('operation', 'remove');
        formData.append('tag_id', tagId);

        const response = await fetch('{% url "students:student_tag_management" student.id %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });

        const data = await response.json();

        if (data.success) {
            // Update current tags for modal
            currentStudentTags = data.current_tags;

            // Update main page tag display
            updateMainPageTags();

            // Show success message
            alert(`Tag "${tagName}" removed successfully`);
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        console.error('Error removing tag:', error);
        alert('An error occurred while removing the tag');
    }
}

function updateMainPageTags() {
    const container = document.getElementById('studentTagsContainer');

    if (currentStudentTags.length === 0) {
        container.innerHTML = '<span class="text-muted" id="no-tags-message">No tags assigned to this student</span>';
        return;
    }

    let html = '';
    currentStudentTags.forEach(tag => {
        html += `
            <span class="badge tag-badge me-2 mb-2" style="background-color: ${tag.colour};" id="student-tag-${tag.id}">
                ${tag.name}
                <button type="button" class="btn-close btn-close-white ms-2" style="font-size: 0.65rem;"
                        onclick="removeTagFromStudent(${tag.id}, '${tag.name}')"
                        title="Remove tag"></button>
            </span>
        `;
    });

    container.innerHTML = html;
}

function showTagMessage(message, type) {
    // Create a temporary alert div
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Insert at the top of modal body
    const modalBody = document.querySelector('#tagManagementModal .modal-body');
    modalBody.insertBefore(alertDiv, modalBody.firstChild);

    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

async function openNotificationModal(studentIds) {
    selectedStudentIds = studentIds;
    document.getElementById('studentIds').value = studentIds.join(',');
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
    modal.show();
    
    // Load quota information
    await loadQuotaInfo();
    
    // Load recipient information
    loadRecipientInfo(studentIds);
    
    // Reset form
    document.getElementById('notificationForm').reset();
    document.getElementById('studentIds').value = studentIds.join(',');
    toggleEmailFields();
    updateCharCount();
}

async function loadQuotaInfo() {
    try {
        const response = await fetch('{% url "core:get_notification_quotas" %}');
        const data = await response.json();
        
        if (data.success) {
            const quotas = data.quotas;
            
            // Update email quota display
            document.getElementById('emailQuota').textContent = 
                `${quotas.email.used}/${quotas.email.limit} (${quotas.email.remaining} remaining)`;
            document.getElementById('emailProgressBar').style.width = `${quotas.email.percentage}%`;
            document.getElementById('emailProgressBar').className = 
                `progress-bar ${quotas.email.percentage > 90 ? 'bg-danger' : quotas.email.percentage > 70 ? 'bg-warning' : 'bg-success'}`;
            
            // Update SMS quota display
            document.getElementById('smsQuota').textContent = 
                `${quotas.sms.used}/${quotas.sms.limit} (${quotas.sms.remaining} remaining)`;
            document.getElementById('smsProgressBar').style.width = `${quotas.sms.percentage}%`;
            document.getElementById('smsProgressBar').className = 
                `progress-bar ${quotas.sms.percentage > 90 ? 'bg-danger' : quotas.sms.percentage > 70 ? 'bg-warning' : 'bg-success'}`;
            
            // Show quota info
            document.getElementById('quotaInfo').style.display = 'block';
        }
    } catch (error) {
        console.error('Failed to load quota information:', error);
    }
}

function loadRecipientInfo(studentIds) {
    // For single student, we can show the current student info
    if (studentIds.length === 1 && studentIds[0] === {{ student.pk }}) {
        const contactInfo = getStudentContactDisplay();
        document.getElementById('recipientList').innerHTML = contactInfo;
    } else {
        document.getElementById('recipientList').innerHTML = 
            `<strong>${studentIds.length}</strong> student(s) selected for notification.`;
    }
}

function getStudentContactDisplay() {
    // Display contact information based on enrollment logic
    const name = '{{ student.first_name }} {{ student.last_name }}';
    let contactInfo = `<strong>${name}</strong><br>`;
    
    // Check if we have guardian info (under 18 logic)
    {% if student.guardian_name %}
        contactInfo += '<i class="fas fa-user-friends me-1"></i>Guardian Contact: {{ student.guardian_name }}';
        {% if student.contact_email %}
            contactInfo += ' ({{ student.contact_email }})';
        {% endif %}
        {% if student.contact_phone %}
            contactInfo += ' - {{ student.contact_phone }}';
        {% endif %}
    {% else %}
        contactInfo += '<i class="fas fa-user me-1"></i>Direct Contact: ';
        {% if student.contact_email %}
            contactInfo += '{{ student.contact_email }}';
        {% endif %}
        {% if student.contact_phone %}
            contactInfo += ' - {{ student.contact_phone }}';
        {% endif %}
    {% endif %}
    
    return contactInfo;
}

function toggleEmailFields() {
    const notificationType = document.getElementById('notificationType').value;
    const subjectField = document.getElementById('subjectField');
    
    if (notificationType === 'email' || notificationType === 'both') {
        subjectField.style.display = 'block';
        document.getElementById('subject').required = true;
    } else {
        subjectField.style.display = 'none';
        document.getElementById('subject').required = false;
    }
}

function updateCharCount() {
    const message = document.getElementById('message').value;
    const charCount = document.getElementById('charCount');
    charCount.textContent = message.length;
    
    if (message.length > 160) {
        charCount.parentElement.classList.add('text-danger');
    } else {
        charCount.parentElement.classList.remove('text-danger');
    }
}

async function sendNotification() {
    const form = document.getElementById('notificationForm');
    const formData = new FormData(form);
    const sendBtn = document.getElementById('sendNotificationBtn');
    
    // Disable send button
    sendBtn.disabled = true;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
    
    try {
        const response = await fetch('{% url "core:send_notification" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Show success message
            alert(`Success! ${data.message}`);
            
            // Hide modal
            bootstrap.Modal.getInstance(document.getElementById('notificationModal')).hide();
            
            // Reload quota info
            await loadQuotaInfo();
        } else {
            // Show error
            let errorMsg = 'Failed to send notification:';
            if (data.error) {
                errorMsg += ' ' + data.error;
            }
            if (data.errors && Object.keys(data.errors).length > 0) {
                errorMsg += ' ' + Object.values(data.errors).flat().join(', ');
            }
            alert(errorMsg);
        }
    } catch (error) {
        console.error('Error sending notification:', error);
        alert('An error occurred while sending the notification. Please try again.');
    } finally {
        // Re-enable send button
        sendBtn.disabled = false;
        sendBtn.innerHTML = '<i class="fas fa-paper-plane me-2"></i>Send Notification';
    }
}

// Event listeners
document.getElementById('message').addEventListener('input', updateCharCount);
document.addEventListener('DOMContentLoaded', function() {
    toggleEmailFields();
    updateCharCount();
});
</script>

{% endblock %}