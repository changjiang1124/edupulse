{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Enrollment - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: #f8f9fa;
        border-radius: 0.375rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
    }
    .form-section h6 {
        color: #495057;
        margin-bottom: 1rem;
    }
    .student-info-alert {
        background-color: #e3f2fd;
        border-left: 4px solid #2196f3;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-1">Edit Enrollment</h1>
                    <p class="text-muted mb-0">Modify enrollment details for {{ enrollment.student.get_full_name }}</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="{% url 'enrollment:enrollment_detail' enrollment.pk %}" class="btn btn-outline-info">
                        <i class="fas fa-eye me-2"></i>View Details
                    </a>
                    <a href="{% url 'enrollment:enrollment_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Enrollments
                    </a>
                </div>
            </div>

            <!-- Form -->
            <div class="row">
                <div class="col-lg-8">
                    <form method="post" novalidate id="enrollmentUpdateForm">
                        {% csrf_token %}

                        <!-- Basic Enrollment Information -->
                        <div class="form-section">
                            <h6 class="fw-bold">
                                <i class="fas fa-edit me-2"></i>Enrollment Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.student.id_for_label }}" class="form-label">
                                            Student <span class="text-danger">*</span>
                                            <a href="{% url 'students:student_detail' enrollment.student.pk %}"
                                               class="btn btn-sm btn-outline-primary ms-2"
                                               title="View Student Profile">
                                                <i class="fas fa-external-link-alt"></i>
                                            </a>
                                        </label>
                                        {{ form.student }}
                                        {% if form.student.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.student.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="{{ form.course.id_for_label }}" class="form-label">
                                            Course <span class="text-danger">*</span>
                                        </label>
                                        {{ form.course }}
                                        {% if form.course.help_text %}
                                            <div class="form-text">{{ form.course.help_text }}</div>
                                        {% endif %}
                                        {% if form.course.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.course.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.status.id_for_label }}" class="form-label">
                                            Status <span class="text-danger">*</span>
                                        </label>
                                        {{ form.status }}
                                        {% if form.status.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.status.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.registration_status.id_for_label }}" class="form-label">
                                            Registration Status
                                        </label>
                                        {{ form.registration_status }}
                                        {% if form.registration_status.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.registration_status.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label for="{{ form.class_instance.id_for_label }}" class="form-label">
                                            Class Instance
                                        </label>
                                        {{ form.class_instance }}
                                        {% if form.class_instance.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.class_instance.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Student Basic Information -->
                        <div class="form-section" id="studentBasicInfo">
                            <h6 class="fw-bold">
                                <i class="fas fa-user me-2"></i>Student Basic Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.student_birth_date.label_tag }}
                                        {{ form.student_birth_date }}
                                        {% if form.student_birth_date.help_text %}
                                            <div class="form-text">{{ form.student_birth_date.help_text }}</div>
                                        {% endif %}
                                        {% if form.student_birth_date.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.student_birth_date.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.student_address.label_tag }}
                                        {{ form.student_address }}
                                        {% if form.student_address.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.student_address.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="form-section" id="contactInfo">
                            <h6 class="fw-bold">
                                <i class="fas fa-phone me-2"></i>Contact Information
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.student_email.label_tag }}
                                        {{ form.student_email }}
                                        {% if form.student_email.help_text %}
                                            <div class="form-text">{{ form.student_email.help_text }}</div>
                                        {% endif %}
                                        {% if form.student_email.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.student_email.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.student_phone.label_tag }}
                                        {{ form.student_phone }}
                                        {% if form.student_phone.help_text %}
                                            <div class="form-text">{{ form.student_phone.help_text }}</div>
                                        {% endif %}
                                        {% if form.student_phone.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.student_phone.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Guardian Information -->
                        <div class="form-section" id="guardianInfo" style="display: none;">
                            <h6 class="fw-bold">
                                <i class="fas fa-user-shield me-2"></i>Guardian Information
                            </h6>
                            <div class="alert alert-info mb-3" role="alert">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Guardian information is required for students under 18 years of age.
                                </small>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        {{ form.guardian_name.label_tag }}
                                        {{ form.guardian_name }}
                                        {% if form.guardian_name.help_text %}
                                            <div class="form-text">{{ form.guardian_name.help_text }}</div>
                                        {% endif %}
                                        {% if form.guardian_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.guardian_name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Emergency Contact -->
                        <div class="form-section" id="emergencyContact">
                            <h6 class="fw-bold">
                                <i class="fas fa-phone-square-alt me-2"></i>Emergency Contact
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.emergency_contact_name.label_tag }}
                                        {{ form.emergency_contact_name }}
                                        {% if form.emergency_contact_name.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.emergency_contact_name.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.emergency_contact_phone.label_tag }}
                                        {{ form.emergency_contact_phone }}
                                        {% if form.emergency_contact_phone.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.emergency_contact_phone.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Medical & Special Requirements -->
                        <div class="form-section" id="medicalInfo">
                            <h6 class="fw-bold">
                                <i class="fas fa-heartbeat me-2"></i>Medical & Special Requirements
                            </h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.medical_conditions.label_tag }}
                                        {{ form.medical_conditions }}
                                        {% if form.medical_conditions.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.medical_conditions.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        {{ form.special_requirements.label_tag }}
                                        {{ form.special_requirements }}
                                        {% if form.special_requirements.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.special_requirements.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fee Management -->
                        <div class="form-section">
                            <h6 class="fw-bold">
                                <i class="fas fa-dollar-sign me-2"></i>Fee Management
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.course_fee.label_tag }}
                                        {{ form.course_fee }}
                                        {% if form.course_fee.help_text %}
                                            <div class="form-text">{{ form.course_fee.help_text }}</div>
                                        {% endif %}
                                        {% if form.course_fee.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.course_fee.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        {{ form.registration_fee.label_tag }}
                                        {{ form.registration_fee }}
                                        {% if form.registration_fee.help_text %}
                                            <div class="form-text">{{ form.registration_fee.help_text }}</div>
                                        {% endif %}
                                        {% if form.registration_fee.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.registration_fee.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Total Fee</label>
                                        <div class="form-control-plaintext fw-bold text-success" id="totalFeeDisplay">
                                            $<span id="totalFeeAmount">{{ enrollment.get_total_fee|default:0 }}</span>
                                        </div>
                                        <div class="form-text">Automatically calculated</div>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        {{ form.charge_registration_fee }}
                                        {{ form.charge_registration_fee.label_tag }}
                                        {% if form.charge_registration_fee.help_text %}
                                            <div class="form-text">{{ form.charge_registration_fee.help_text }}</div>
                                        {% endif %}
                                        {% if form.charge_registration_fee.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.charge_registration_fee.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check mb-3">
                                        {{ form.registration_fee_paid }}
                                        {{ form.registration_fee_paid.label_tag }}
                                        {% if form.registration_fee_paid.help_text %}
                                            <div class="form-text">{{ form.registration_fee_paid.help_text }}</div>
                                        {% endif %}
                                        {% if form.registration_fee_paid.errors %}
                                            <div class="invalid-feedback d-block">
                                                {% for error in form.registration_fee_paid.errors %}
                                                    {{ error }}
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info" role="alert">
                                <small>
                                    <i class="fas fa-info-circle me-1"></i>
                                    Uncheck "Charge Registration Fee" to set registration fee to $0.
                                    Mark "Registration Fee Paid" when payment is received.
                                </small>
                            </div>
                        </div>

                        <!-- Email Notification Options -->
                        <div class="form-section">
                            <h6 class="fw-bold">
                                <i class="fas fa-envelope me-2"></i>Update Notification
                            </h6>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-check">
                                        {{ form.send_update_notification }}
                                        {{ form.send_update_notification.label_tag }}
                                    </div>
                                    {% if form.send_update_notification.help_text %}
                                        <div class="form-text">{{ form.send_update_notification.help_text }}</div>
                                    {% endif %}
                                    <div class="alert alert-info mt-2" role="alert">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            If enabled and the enrollment status changes, an update notification will be sent to the student/guardian.
                                        </small>
                                    </div>
                                    {% if form.send_update_notification.errors %}
                                        <div class="invalid-feedback d-block">
                                            {% for error in form.send_update_notification.errors %}
                                                {{ error }}
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- Hidden Fields -->
                        {{ form.source_channel }}

                        <!-- Submit Section -->
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Update Enrollment
                                </button>
                                <a href="{% url 'enrollment:enrollment_detail' enrollment.pk %}" class="btn btn-outline-secondary">
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Sidebar with helpful information -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>Edit Guidelines
                            </h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-unstyled mb-0">
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Course cannot be changed once enrollment is created
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Guardian info appears automatically for students under 18
                                </li>
                                <li class="mb-2">
                                    <i class="fas fa-check text-success me-2"></i>
                                    Email notifications are sent only when status changes
                                </li>
                                <li class="mb-0">
                                    <i class="fas fa-check text-success me-2"></i>
                                    All changes are logged for audit purposes
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Current Enrollment Status -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-clipboard-list me-2"></i>Current Status
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Status:</strong>
                                <span class="badge bg-{{ enrollment.status|default:'secondary' }} ms-1">
                                    {{ enrollment.get_status_display }}
                                </span>
                            </div>
                            <div class="mb-2">
                                <strong>Registration:</strong> {{ enrollment.get_registration_status_display }}
                            </div>
                            {% if enrollment.created_at %}
                                <div class="mb-0">
                                    <strong>Created:</strong> {{ enrollment.created_at|date:"M d, Y" }}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Fee Status Information -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="card-title mb-0">
                                <i class="fas fa-dollar-sign me-2"></i>Fee Status
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="mb-2">
                                <strong>Course Fee:</strong> ${{ enrollment.course_fee|default:enrollment.course.price }}
                            </div>
                            <div class="mb-2">
                                <strong>Registration Fee:</strong> ${{ enrollment.registration_fee|default:0 }}
                                {% if enrollment.registration_fee_paid %}
                                    <span class="badge bg-success ms-1">Paid</span>
                                {% else %}
                                    <span class="badge bg-warning ms-1">Unpaid</span>
                                {% endif %}
                            </div>
                            <hr>
                            <div class="mb-0">
                                <strong>Total Fee:</strong>
                                <span class="text-success fw-bold">${{ enrollment.get_total_fee }}</span>
                            </div>
                            {% if enrollment.is_early_bird %}
                                <div class="mt-2">
                                    <small class="text-info">
                                        <i class="fas fa-tag me-1"></i>Early Bird Pricing Applied
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Age detection elements
    const birthDateField = document.getElementById('id_student_birth_date');
    const guardianInfo = document.getElementById('guardianInfo');
    const guardianNameField = document.getElementById('id_guardian_name');

    // Fee calculation elements
    const courseFeeField = document.getElementById('id_course_fee');
    const registrationFeeField = document.getElementById('id_registration_fee');
    const chargeRegistrationFeeCheckbox = document.getElementById('id_charge_registration_fee');
    const totalFeeAmount = document.getElementById('totalFeeAmount');

    // Age detection functionality
    if (birthDateField && guardianInfo && guardianNameField) {
        birthDateField.addEventListener('change', function() {
            checkStudentAge();
        });

        // Initial check if birth date is already filled
        if (birthDateField.value) {
            checkStudentAge();
        }
    }

    // Fee calculation functionality
    if (courseFeeField && registrationFeeField && chargeRegistrationFeeCheckbox && totalFeeAmount) {
        // Add event listeners for real-time calculation
        courseFeeField.addEventListener('input', calculateTotalFee);
        registrationFeeField.addEventListener('input', calculateTotalFee);
        chargeRegistrationFeeCheckbox.addEventListener('change', function() {
            toggleRegistrationFee();
            calculateTotalFee();
        });

        // Initial calculation
        toggleRegistrationFee();
        calculateTotalFee();
    }

    function checkStudentAge() {
        if (!birthDateField.value) {
            // Hide guardian info if no birth date
            guardianInfo.style.display = 'none';
            guardianNameField.required = false;
            return;
        }

        const birthDate = new Date(birthDateField.value);
        const today = new Date();
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();

        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }

        if (age < 18) {
            // Student is under 18 - show guardian info
            guardianInfo.style.display = 'block';
            guardianNameField.required = true;
        } else {
            // Student is 18 or over - hide guardian info
            guardianInfo.style.display = 'none';
            guardianNameField.required = false;
        }
    }

    function toggleRegistrationFee() {
        if (chargeRegistrationFeeCheckbox && registrationFeeField) {
            if (chargeRegistrationFeeCheckbox.checked) {
                registrationFeeField.disabled = false;
                registrationFeeField.style.opacity = '1';
            } else {
                registrationFeeField.disabled = true;
                registrationFeeField.style.opacity = '0.5';
                registrationFeeField.value = '0';
            }
        }
    }

    function calculateTotalFee() {
        if (!courseFeeField || !registrationFeeField || !chargeRegistrationFeeCheckbox || !totalFeeAmount) {
            return;
        }

        const courseFee = parseFloat(courseFeeField.value) || 0;
        const registrationFee = chargeRegistrationFeeCheckbox.checked ? (parseFloat(registrationFeeField.value) || 0) : 0;
        const total = courseFee + registrationFee;

        totalFeeAmount.textContent = total.toFixed(2);

        // Update visual feedback
        if (total > 0) {
            totalFeeAmount.parentElement.classList.remove('text-muted');
            totalFeeAmount.parentElement.classList.add('text-success');
        } else {
            totalFeeAmount.parentElement.classList.remove('text-success');
            totalFeeAmount.parentElement.classList.add('text-muted');
        }
    }

    // Form validation enhancement
    const form = document.getElementById('enrollmentUpdateForm');
    if (form) {
        form.addEventListener('submit', function(event) {
            // Validate fee amounts
            const courseFee = parseFloat(courseFeeField?.value || 0);
            const registrationFee = parseFloat(registrationFeeField?.value || 0);

            if (courseFee < 0) {
                event.preventDefault();
                alert('Course fee cannot be negative.');
                courseFeeField.focus();
                return false;
            }

            if (chargeRegistrationFeeCheckbox?.checked && registrationFee < 0) {
                event.preventDefault();
                alert('Registration fee cannot be negative.');
                registrationFeeField.focus();
                return false;
            }
        });
    }
});
</script>
{% endblock %}