{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="h3 mb-0">Timesheet</h1>
    <div>
        <a href="{% url 'timesheet_export' %}" class="btn btn-success me-2">
            <i class="fa-solid fa-file-export me-1"></i> Export
        </a>
        <a href="{% url 'clock' %}" class="btn btn-outline-secondary">
            <i class="fa-solid fa-arrow-left me-1"></i> Back to Clock
        </a>
    </div>
  </div>

  <!-- Date Filter -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">
        <div class="col-sm-6 col-md-4">
          <label for="start_date" class="form-label">Start Date</label>
          <input type="date" id="start_date" name="start_date" value="{{ start_date }}" class="form-control">
        </div>
        <div class="col-sm-6 col-md-4">
          <label for="end_date" class="form-label">End Date</label>
          <input type="date" id="end_date" name="end_date" value="{{ end_date }}" class="form-control">
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary w-100">
            <i class="fa-solid fa-magnifying-glass me-1"></i> Filter
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3 mb-4">
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-body text-center">
          <h6 class="text-muted text-uppercase small mb-2">Total Hours</h6>
          <p class="h2 mb-0 text-primary">{{ summary.total_hours|default:"0" }}h</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-body text-center">
          <h6 class="text-muted text-uppercase small mb-2">Days Worked</h6>
          <p class="h2 mb-0">{{ summary.total_days|default:"0" }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card bg-light h-100">
        <div class="card-body text-center">
          <h6 class="text-muted text-uppercase small mb-2">Completed Sessions</h6>
          <p class="h2 mb-0">{{ summary.completed_sessions|default:"0" }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Timesheet Table -->
  <div class="card shadow-sm">
    <div class="card-body">
      {% if paired_records %}
        <div class="table-responsive">
          <table class="table table-striped align-middle mb-0">
            <thead>
              <tr>
                <th scope="col">Date</th>
                <th scope="col">Session Time</th>
                <th scope="col">Duration</th>
                <th scope="col">Facility</th>
                <th scope="col">Activity / Classes</th>
                <th scope="col">Status</th>
              </tr>
            </thead>
            <tbody>
              {% for record in paired_records %}
                <tr>
                  <td class="text-nowrap">{{ record.date|date:"D, d M" }}</td>
                  <td class="text-nowrap">
                    {% if record.clock_in_time %}
                      {{ record.clock_in_time|date:"H:i" }}
                    {% else %}
                      <span class="text-danger">--:--</span>
                    {% endif %}
                     - 
                    {% if record.clock_out_time %}
                      {{ record.clock_out_time|date:"H:i" }}
                    {% else %}
                      <span class="text-danger">--:--</span>
                    {% endif %}
                  </td>
                  <td class="fw-bold">
                    {% if record.duration_hours %}
                      {{ record.duration_hours|floatformat:1 }}h
                    {% else %}
                      -
                    {% endif %}
                  </td>
                  <td class="text-nowrap">
                    {{ record.facility.name|default:"-" }}
                  </td>
                  <td>
                    {% if record.classes %}
                      {% for cls in record.classes %}
                        <span class="badge bg-secondary mb-1">{{ cls.course.name }}</span>
                      {% endfor %}
                    {% else %}
                      <span class="text-muted fst-italic">General Work</span>
                    {% endif %}
                  </td>
                  <td>
                    {% if record.is_complete %}
                      <span class="badge bg-success">Complete</span>
                    {% else %}
                      <span class="badge bg-warning text-dark">
                        {% if not record.clock_in %}Missing In{% elif not record.clock_out %}Active{% endif %}
                      </span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="text-center py-5">
            <i class="fa-regular fa-clock fa-3x text-muted mb-3"></i>
            <p class="text-muted mb-0">No records found for the selected period.</p>
        </div>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Enhance date inputs to ensure start <= end
(function() {
  const start = document.getElementById('start_date');
  const end = document.getElementById('end_date');
  if (!start || !end) return;

  function clampDates() {
    if (start.value && end.value && start.value > end.value) {
      end.value = start.value;
    }
  }

  start.addEventListener('change', clampDates);
  end.addEventListener('change', clampDates);
})();
</script>
{% endblock %}
