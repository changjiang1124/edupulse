{% extends 'base.html' %}
{% load static %}

{% block title %}Teacher Attendance - EduPulse{% endblock %}

{% block extra_css %}
<style>
    /* attendance-panel */
    .attendance-panel {
        max-width: 600px;
        margin: 0 auto;
        border: none;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .attendance-header {
        background: #fff;
        padding: 2.5rem 2rem 1rem;
        text-align: center;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .live-clock {
        font-size: 3.5rem;
        font-weight: 700;
        color: #2c3e50;
        line-height: 1;
        margin-bottom: 0.5rem;
        font-variant-numeric: tabular-nums;
        letter-spacing: -1px;
    }
    
    .live-date {
        color: #6c757d;
        font-size: 1.1rem;
        font-weight: 500;
    }
    
    .status-badge {
        display: inline-flex;
        align-items: center;
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
    }
    
    .status-badge.clocked-in {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    
    .status-badge.clocked-out {
        background-color: #f8f9fa;
        color: #6c757d;
        border: 1px solid #dee2e6;
    }

    .attendance-body {
        padding: 2rem;
        background: #fff;
    }

    /* Location Indicator */
    .location-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: 1px solid #e9ecef;
        transition: all 0.2s;
    }

    .location-status-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 1rem;
        flex-shrink: 0;
    }

    .status-icon-pending { background: #fff3e0; color: #f57c00; }
    .status-icon-success { background: #e8f5e9; color: #2e7d32; }
    .status-icon-error { background: #ffebee; color: #d32f2f; }

    /* Class Selection */
    .class-selection-container {
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .class-item {
        padding: 0.75rem;
        border-radius: 8px;
        border: 1px solid transparent;
        transition: all 0.2s;
        cursor: pointer;
        margin-bottom: 0.5rem;
        background: #fff;
    }
    
    .class-item:last-child { margin-bottom: 0; }
    
    .class-item:hover {
        background: #f8f9fa;
        border-color: #e9ecef;
    }
    
    .class-item.selected {
        background: #e3f2fd;
        border-color: #90caf9;
    }

    /* Actions */
    .action-btn-lg {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
        font-weight: 600;
        border-radius: 12px;
        transition: transform 0.1s;
    }
    
    .action-btn-lg:active {
        transform: scale(0.98);
    }

    .btn-clock-in {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(56, 239, 125, 0.3);
    }

    .btn-clock-out {
        background: linear-gradient(135deg, #cb2d3e 0%, #ef473a 100%);
        border: none;
        color: white;
        box-shadow: 0 4px 15px rgba(239, 71, 58, 0.3);
    }

    .recent-activity-feed {
        margin-top: 3rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
    }

    .activity-item {
        padding: 1rem 0;
        border-bottom: 1px solid #f0f0f0;
        display: flex;
        align-items: center;
    }
    
    .activity-item:last-child { border-bottom: none; }
    
    .activity-time {
        width: 80px;
        font-weight: 600;
        color: #2c3e50;
    }
    
    .activity-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    
    <!-- Main Attendance Panel -->
    <div class="attendance-panel bg-white">
        <!-- Header with Clock -->
        <div class="attendance-header">
            {% if is_clocked_in %}
                <div class="status-badge clocked-in">
                    <i class="fas fa-check-circle me-2"></i>Currently Clocked In
                </div>
            {% else %}
                <div class="status-badge clocked-out">
                    <i class="far fa-circle me-2"></i>Currently Clocked Out
                </div>
            {% endif %}

            <div class="live-clock" id="liveClock">--:--</div>
            <div class="live-date">{{ today|date:"l, F jS" }}</div>
        </div>

        <div class="attendance-body">
            <!-- Alert Area -->
            <div id="feedbackAlert" class="alert d-none mb-4" role="alert"></div>

            {% if has_overdue_clock_out %}
            <div class="alert alert-warning border-0 bg-warning bg-opacity-10 text-warning mb-4">
                <div class="d-flex">
                    <i class="fas fa-exclamation-triangle mt-1 me-3"></i>
                    <div>
                        <h6 class="alert-heading fw-bold mb-1">Pending Clock Out</h6>
                        <p class="mb-0 small">You remained clocked in from {{ latest_record.timestamp|date:"l, d M" }}. Please clock out to close usage.</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Location Status Card -->
            <div class="location-card">
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <div id="locationIcon" class="location-status-icon status-icon-pending">
                            <i class="fas fa-satellite-dish"></i>
                        </div>
                        <div>
                            <div id="locationTitle" class="fw-bold text-dark">Locating...</div>
                            <div id="locationDesc" class="small text-muted">Waiting for GPS signal</div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-light border text-muted" 
                            id="retryLocationBtn" onclick="requestLocation()" style="display:none;">
                        <i class="fas fa-redo-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Class Selection (Hidden by default, shown if classes exist) -->
            <div id="classesSection" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="fw-bold mb-0">Scheduled Classes</h6>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-link text-decoration-none p-0 me-3 text-muted" onclick="selectAllClasses()">Select All</button>
                        <button type="button" class="btn btn-link text-decoration-none p-0 text-muted" onclick="clearAllClasses()">Clear</button>
                    </div>
                </div>
                <div id="classesList" class="class-selection-container p-2 border-0 bg-light">
                    <!-- Classes injected via JS -->
                </div>
            </div>

            <!-- Notes -->
            <div class="mb-4">
                <textarea class="form-control bg-light border-0" id="clockNotes" rows="2" 
                          placeholder="Add optional notes..." style="resize: none;"></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="row g-2">
                {% if is_clocked_in %}
                    <div class="col-12">
                        <button type="button" class="btn btn-clock-out action-btn-lg" 
                                id="clockOutBtn" onclick="submitClock('clock_out')" disabled>
                            <i class="fas fa-sign-out-alt me-2"></i>Clock Out
                        </button>
                    </div>
                {% else %}
                    <div class="col-12">
                        <button type="button" class="btn btn-clock-in action-btn-lg" 
                                id="clockInBtn" onclick="submitClock('clock_in')" disabled>
                            <i class="fas fa-sign-in-alt me-2"></i>Clock In
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Activity Simplified -->
    <div class="recent-activity-feed">
        <h6 class="text-uppercase text-muted small fw-bold mb-3 ps-2">Recent Activity</h6>
        <div class="bg-white rounded-4 p-3 shadow-sm border border-light">
            {% if recent_records %}
                {% for record in recent_records|slice:":3" %}
                <div class="activity-item">
                    <div class="activity-time text-end pe-3">{{ record.timestamp|date:"H:i" }}</div>
                    <div class="activity-dot {% if record.clock_type == 'clock_in' %}bg-success{% else %}bg-danger{% endif %}"></div>
                    <div class="flex-grow-1">
                        <div class="fw-medium text-dark">{{ record.get_clock_type_display }}</div>
                        <div class="small text-muted">{{ record.facility.name }}</div>
                    </div>
                </div>
                {% endfor %}
                <div class="text-center mt-2 border-top pt-2">
                    <a href="{% url 'teacher_attendance_history' %}" class="text-decoration-none small text-primary fw-medium">View History</a>
                </div>
            {% else %}
                <p class="text-center text-muted small mb-0 py-2">No recent activity today.</p>
            {% endif %}
        </div>
    </div>

</div>

<!-- Loading Overlay/Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <h6 class="mb-0" id="loadingMessage">Processing...</h6>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentLocation = null;
let selectedClasses = [];
let locationVerified = false;
let facilityData = null;
let hasClassesAvailable = false;
// Global state from Django context
const isClockedIn = {{ is_clocked_in|yesno:"true,false" }};
const hasOverdueClockOut = {{ has_overdue_clock_out|yesno:"true,false" }};
const overdueClockOutDate = "{{ overdue_clock_out_date|date:'l, d M'|escapejs }}";

// Location configuration
const locationOptions = { enableHighAccuracy: true, timeout: 15000, maximumAge: 300000 };

document.addEventListener('DOMContentLoaded', function() {
    startClock();
    requestLocation();
});

// --- UI Updates ---

function startClock() {
    const update = () => {
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-AU', {
            hour12: false, hour: '2-digit', minute: '2-digit' // Removed seconds for cleaner look
        });
        document.getElementById('liveClock').textContent = timeString;
    };
    update();
    setInterval(update, 1000);
}

function updateLocationUI(status, title, desc) {
    const iconEl = document.getElementById('locationIcon');
    const titleEl = document.getElementById('locationTitle');
    const descEl = document.getElementById('locationDesc');
    const retryBtn = document.getElementById('retryLocationBtn');
    
    // Reset classes
    iconEl.className = 'location-status-icon';
    titleEl.className = 'fw-bold';
    retryBtn.style.display = 'none';

    if (status === 'pending') {
        iconEl.classList.add('status-icon-pending');
        iconEl.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div>';
    } else if (status === 'success') {
        iconEl.classList.add('status-icon-success');
        iconEl.innerHTML = '<i class="fas fa-map-marker-alt"></i>';
    } else if (status === 'error') {
        iconEl.classList.add('status-icon-error');
        iconEl.innerHTML = '<i class="fas fa-times"></i>';
        retryBtn.style.display = 'block';
    }

    titleEl.textContent = title;
    descEl.textContent = desc;
}

function showFeedback(type, message, autoHide = true) {
    const alertEl = document.getElementById('feedbackAlert');
    alertEl.className = `alert alert-${type} border-0 shadow-sm mb-4`;
    alertEl.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>${message}`;
    alertEl.classList.remove('d-none');
    if (autoHide) setTimeout(() => alertEl.classList.add('d-none'), 5000);
}

// --- Logic ---

function requestLocation() {
    updateLocationUI('pending', 'Verifying Location', 'Please wait while we check your position...');
    setButtonsDisabled(true);

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(handleLocationSuccess, handleLocationError, locationOptions);
    } else {
        handleLocationError(new Error('Geolocation not supported'));
    }
}

function handleLocationSuccess(position) {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    currentLocation = { latitude: lat, longitude: lon };
    
    // Send to server for verification
    fetch('{% url "teacher_location_verify" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ latitude: lat, longitude: lon })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            handleVerified(data);
        } else {
            handleLocationError({ message: data.error });
        }
    })
    .catch(err => handleLocationError({ message: 'Server verification failed' }));
}

function handleLocationError(error) {
    console.error("Location Error", error);
    updateLocationUI('error', 'Location Failed', error.message || 'Could not verify location.');
    setButtonsDisabled(true); // Keep disabled if location fails
}

function handleVerified(data) {
    locationVerified = true;
    facilityData = data.facility;
    hasClassesAvailable = !!data.has_classes;
    
    updateLocationUI('success', data.facility.name, `Verified • ${data.distance}m away`);
    
    // Enable relevant buttons
    setButtonsDisabled(false);

    // Show classes if any, only if we are ready to clock in (not already clocked in)
    if (!isClockedIn) {
        if (data.has_classes) {
            renderClasses(data.classes);
        } else {
            renderNoClasses();
        }
    }
}

function setButtonsDisabled(disabled) {
    const inBtn = document.getElementById('clockInBtn');
    const outBtn = document.getElementById('clockOutBtn');
    if (inBtn) inBtn.disabled = disabled;
    if (outBtn) outBtn.disabled = disabled;
}

// --- Class Handling ---

function renderClasses(classes) {
    const section = document.getElementById('classesSection');
    const container = document.getElementById('classesList');
    const header = section.querySelector('h6');
    const actions = section.querySelector('.btn-group');
    section.style.display = 'block';
    if (header) {
        header.textContent = 'Scheduled Classes';
        header.classList.remove('text-muted');
    }
    if (actions) actions.style.display = 'flex';
    
    let html = '';
    classes.forEach(cls => {
        html += `
            <div class="class-item d-flex align-items-center justify-content-between" 
                 onclick="toggleClass(this, ${cls.id})" id="classItem_${cls.id}">
                <div>
                    <div class="fw-bold text-dark">${cls.course_name}</div>
                    <div class="small text-muted">
                        <i class="far fa-clock me-1"></i>${cls.start_time}
                        <span class="mx-1">•</span>
                        ${cls.classroom}
                    </div>
                </div>
                <div class="form-check pointer-events-none">
                    <input class="form-check-input" type="checkbox" id="check_${cls.id}">
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
    
    // Auto select all
    selectAllClasses();
}

function renderNoClasses() {
    const section = document.getElementById('classesSection');
    const container = document.getElementById('classesList');
    const header = section.querySelector('h6');
    const actions = section.querySelector('.btn-group');
    section.style.display = 'block';
    if (header) {
        header.textContent = 'No Scheduled Classes';
        header.classList.add('text-muted');
    }
    if (actions) actions.style.display = 'none';
    selectedClasses = [];
    container.innerHTML = `
        <div class="alert alert-info mb-0">
            <i class="fas fa-info-circle me-2"></i>
            No classes scheduled today. You can still clock in for general attendance.
        </div>
    `;
}

function toggleClass(el, id) {
    const input = document.getElementById(`check_${id}`);
    const index = selectedClasses.indexOf(id);
    
    if (index === -1) {
        selectedClasses.push(id);
        el.classList.add('selected');
        input.checked = true;
    } else {
        selectedClasses.splice(index, 1);
        el.classList.remove('selected');
        input.checked = false;
    }
}

function selectAllClasses() {
    const inputs = document.querySelectorAll('#classesList input[type="checkbox"]');
    selectedClasses = [];
    inputs.forEach(input => {
        const id = parseInt(input.id.replace('check_', ''));
        selectedClasses.push(id);
        input.checked = true;
        document.getElementById(`classItem_${id}`).classList.add('selected');
    });
}

function clearAllClasses() {
    selectedClasses = [];
    document.querySelectorAll('#classesList input[type="checkbox"]').forEach(i => i.checked = false);
    document.querySelectorAll('.class-item').forEach(el => el.classList.remove('selected'));
}

// --- Submission ---

function submitClock(type) {
    // Validation
    if (!locationVerified) {
        showFeedback('warning', 'Please wait for location verification.');
        return;
    }
    
    if (type === 'clock_in' && hasClassesAvailable && selectedClasses.length === 0) {
        if (!confirm('No classes selected. Continue as General Attendance?')) return;
    }
    
    if (type === 'clock_out' && hasOverdueClockOut) {
        if (!confirm('You are closing a previous overdue session. Continue?')) return;
    }

    // Prepare data
    const notes = document.getElementById('clockNotes').value;
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    document.getElementById('loadingMessage').textContent = type === 'clock_in' ? 'Clocking In...' : 'Clocking Out...';
    modal.show();

    fetch('{% url "teacher_clock_submit" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            clock_type: type,
            latitude: currentLocation.latitude,
            longitude: currentLocation.longitude,
            facility_id: facilityData.id,
            class_ids: selectedClasses,
            notes: notes
        })
    })
    .then(r => r.json())
    .then(data => {
        setTimeout(() => { // minimal UI delay
            modal.hide();
            if (data.success) {
                showFeedback('success', 'Success! Refreshing...');
                location.reload();
            } else {
                showFeedback('danger', data.error || 'Submission failed');
            }
        }, 600);
    })
    .catch(err => {
        modal.hide();
        showFeedback('danger', 'Network error occurred.');
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
